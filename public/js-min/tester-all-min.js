String.prototype.pad=function(a){for(var c=this;c.length<a;)c="0"+c;return c};var profilerRecords=[],xpathEvalNum=0,xpathEvalTime=0;function Profiler(a){var c=(new Date).getTime();this.report=function(b){b=b||"time taken for "+a+" to execute in milliseconds: "+((new Date).getTime()-c);profilerRecords.push(b)}}
function divideIntoBatches(a,c){var b,d,e,f=[],g=[];for(b=0;b<a.length;b++)f.push({index:b,size:a[b]});for(;0<f.length;){e=[f[0].index];d=f[0].size;if(f[0].size<c)for(b=1;b<f.length;b++)d+f[b].size<c&&(e.push(f[b].index),d+=f[b].size);g.push(e);for(b=0;b<f.length;b++)for(d=0;d<e.length;d++)f[b].index===e[d]&&f.splice(b,1)}return g}var helper=new Helper;
function Helper(){this.setSettings=function(){var a,c,b=[{q:"return",s:"returnURL"},{q:"showbranch",s:"showBranch"},{q:"debug",s:"debug"},{q:"touch",s:"touch"},{q:"server",s:"serverURL"},{q:"form",s:"formURL"},{q:"id",s:"formId"},{q:"formName",s:"formId"},{q:"instanceId",s:"instanceId"},{q:"entityId",s:"entityId"}];for(a=0;a<b.length;a++)c=this.getQueryParam(b[a].q),settings[b[a].s]=null!==c?c:"undefined"!==typeof settings[b[a].s]?settings[b[a].s]:null};this.getQueryParam=function(a){var c=this.getAllQueryParams(),
b;for(b in c)if(b.toLowerCase()===a.toLowerCase())return c[b];return null};this.getAllQueryParams=function(){for(var a,c=window.location.search.substring(1).split("&"),b={},d=0;d<c.length;d++){var e=c[d].split("=");0<e[0].length&&(a=encodeURI(e[1]),a="true"===a?!0:"false"===a?!1:a,b[e[0]]=a)}return b}}
window.onload=function(){setTimeout(function(){var a,c;window.performance&&(c=window.performance.timing,c=c.loadEventEnd-c.responseEnd,"undefined"!==typeof settings&&settings.debug&&(a=(a=window.localStorage.getItem("__loadLog"))?JSON.parse(a):[],a.push(c),10<a.length&&a.shift(),window.localStorage.setItem("__loadLog",JSON.stringify(a))),profilerRecords.push("total loading time: "+c+" milliseconds"),window.opener&&(window.performance&&window.postMessage)&&window.opener.postMessage(JSON.stringify(window.performance),
"*"),$(profilerRecords).each(function(a,c){console.log(c)}))},0)};
(function(a){a.fn.getXPath=function(a){for(var b=this.first(),d=[b.prop("nodeName")],b=b.parent(),e=b.prop("nodeName");1==b.length&&e!==a&&"#document"!==e;)d.push(e),b=b.parent(),e=b.prop("nodeName");return"/"+d.reverse().join("/")};a.fn.toLargestWidth=function(c){var b=0,c=c||0;return this.each(function(){a(this).width()>b&&(b=a(this).width())}).each(function(){a(this).width(b+c)})};a.fn.toSmallestWidth=function(){var c=2E3;return this.each(function(){a(this).width()<c&&(c=a(this).width())}).each(function(){a(this).width(c)})};
a.fn.reverse=[].reverse;a.fn.alphanumeric=function(c){c=a.extend({ichars:"!@#$%^&*()+=[]\\';,/{}|\":<>?~`.- ",nchars:"",allow:""},c);return this.each(function(){c.nocaps&&(c.nchars+="ABCDEFGHIJKLMNOPQRSTUVWXYZ");c.allcaps&&(c.nchars+="abcdefghijklmnopqrstuvwxyz");for(var b=c.allow.split(""),d=0;d<b.length;d++)-1!=c.ichars.indexOf(b[d])&&(b[d]="\\"+b[d]);c.allow=b.join("|");var e=c.ichars+c.nchars,e=e.replace(RegExp(c.allow,"gi"),"");a(this).keypress(function(a){var b;b=a.charCode?String.fromCharCode(a.charCode):
String.fromCharCode(a.which);e.indexOf(b)!=-1&&a.preventDefault();a.ctrlKey&&b=="v"&&a.preventDefault()});a(this).bind("contextmenu",function(){return false})})};a.fn.numeric=function(c){var b="abcdefghijklmnopqrstuvwxyz",b=b+b.toUpperCase(),c=a.extend({nchars:b},c);return this.each(function(){a(this).alphanumeric(c)})};a.fn.alpha=function(c){c=a.extend({nchars:"1234567890"},c);return this.each(function(){a(this).alphanumeric(c)})};a.fn.capitalizeStart=function(a){a||(a=1);var b=this.contents().filter(function(){return 3==
this.nodeType}).first(),d=b.text(),a=d.split(" ",a).join(" ");b.length&&(b[0].nodeValue=d.slice(a.length),b.before('<span class="capitalize">'+a+"</span>"))}})(jQuery);/*
 Copyright 2012 Martijn van de Rijdt

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
var gui,printO;$(document).ready(function(){helper.setSettings();gui=new GUI;gui.init();"undefined"==typeof console&&(console={log:function(){}});"undefined"==typeof window.console.debug&&(console.debug=console.log);settings.debug||(window.console.log=function(){},window.console.debug=function(){});settings.touch?(Modernizr.touch=!0,$("html").addClass("touch")):!1===settings.touch&&(Modernizr.touch=!1,$("html").removeClass("touch"));printO=new Print});
function GUI(){this.supportLink='<a href="mailto:'+settings.supportEmail+'">'+settings.supportEmail+"</a>"}GUI.prototype.init=function(){this.nav.setup();this.pages.init();this.setEventHandlers();"function"===typeof this.setCustomEventHandlers&&this.setCustomEventHandlers();$("footer").detach().appendTo("#container");this.positionPageAndBar()};GUI.prototype.setup=function(){$(window).trigger("resize")};
GUI.prototype.setEventHandlers=function(){var a=this;$(document).on("click","#feedback-bar .close",function(){a.feedbackBar.hide();return!1});$(document).on("click",".touch #feedback-bar",function(){a.feedbackBar.hide()});$(document).on("click","#page .close",function(){a.pages.close();return!1});$("button.print").on("click",function(){printO.printForm()});$(document).on("click",'a[href^="#"]:not([href="#"]):not(nav ul li a)',function(a){var b=$(this).attr("href");console.log("captured click to nav page, href="+
b);"#"!==b&&(a.preventDefault(),$('nav li a[href="'+b+'"]').click())});$('nav ul li a[href^="#"]').click(function(c){c.preventDefault();c=$(this).attr("href").substr(1);a.pages.open(c);$(this).closest("li").addClass("active").siblings().removeClass("active")});$(window).on("onlinestatuschange",function(c,b){a.updateStatus.connection(b)});$(document).on("edit","form.jr",function(c,b){a.updateStatus.edit(b)});$(document).on("browsersupport",function(c,b){a.updateStatus.support(b)});$("#page, #feedback-bar").on("change",
function(){a.positionPageAndBar()});$(document).on("xpatherror",function(c,b){var d=settings.supportEmail;a.alert('A formula evaluation error occurred. Please contact <a href="mailto:'+d+"?subject=xpath errors for: "+location.href+"&body="+b+'" target="_blank" >'+d+'</a> with this error:<ul class="error-list"><li>'+b+"</li></ul>","Formula Error")})};
GUI.prototype.nav={setup:function(){$("article.page").each(function(){var a,c="",b;b=$(this).attr("id");a=$(this).attr("data-display-icon")?'<img src="/images/'+$(this).attr("data-display-icon")+'" alt="menu-icon" />':$(this).attr("data-display")?$(this).attr("data-display"):b;c=$(this).attr("data-title")?$(this).attr("data-title"):b;b=$(this).attr("data-ext-link")?$(this).attr("data-ext-link"):"#"+b;$('<li class=""><a href="'+b+'" title="'+c+'" >'+a+"</a></li>").appendTo($("nav ul"))})},reset:function(){$("nav ul li").removeClass("active")}};
GUI.prototype.pages={init:function(){this.$pages=$("<pages></pages>");$("article.page").detach().appendTo(this.$pages)},get:function(a){var c=this.$pages.find('article[id="'+a+'"]');return c=0<c.length?c:$('article[id="'+a+'"]')},isShowing:function(a){return 0<$("#page article.page"+("undefined"!==typeof a?'[id="'+a+'"]':"")).length},open:function(a){$("header");var c=this;this.isShowing(a)||(a=this.get(a),1!==a.length?console.error("page not found"):(this.isShowing()&&this.close(),$("#page .content").prepend(a.show()).trigger("change"),
$("#page").show(),$(".overlay").show(),$(window).on("resize.pageEvents",function(){$("#page").trigger("change")}),setTimeout(function(){$(window).on("click.pageEvents",function(a){console.log($(a.target).prop("nodeName"));0===$(a.target).parents(".btn-toolbar, label, fieldset").length&&c.close();return!0})},1E3)))},close:function(){var a=0<$("#page .page").length?$("#page .page").detach():[];0<a.length&&(this.$pages.append(a),$("#page").trigger("change"),$("nav ul li").removeClass("active"),$(window).off(".pageEvents"));
$(".overlay").hide()}};GUI.prototype.feedbackBar={show:function(a,c){var b,c=c?1E3*c:1E4;$("#feedback-bar p").eq(1).remove();$("#feedback-bar p").html()!==a&&(b=$("<p></p>"),b.append(a),$("#feedback-bar").append(b));$("#feedback-bar").show().trigger("change");setTimeout(function(){typeof b!=="undefined"&&b.remove();$("#feedback-bar").trigger("change")},c)},hide:function(){$("#feedback-bar p").remove();$("#feedback-bar").trigger("change")}};
GUI.prototype.feedback=function(a,c,b,d){b=b||"Information";"fixed"===$("header").css("position")?this.feedbackBar.show(a,c):d?this.confirm({msg:a,heading:b},d,c):this.alert(a,b,"info",c)};
GUI.prototype.alert=function(a,c,b,d){var e,f=$("#dialog-alert"),b=b||"error",b="normal"===b?"":"alert alert-block alert-"+b;f.find(".modal-header h3").text(c||"Alert");f.find(".modal-body p").removeClass().addClass(b).html(a).capitalizeStart();f.modal({keyboard:!0,show:!0});f.on("hidden",function(){f.find(".modal-header h3, .modal-body p").html("");clearInterval(e)});if("number"===typeof d){var g=d.toString();f.find(".self-destruct-timer").text(g);e=setInterval(function(){g--;f.find(".self-destruct-timer").text(g)},
1E3);setTimeout(function(){clearInterval(e);f.find(".close").click()},1E3*d)}};
GUI.prototype.confirm=function(a,c,b){var d,e,f,g,i;"string"===typeof a?d=a:"string"===typeof a.msg&&(d=a.msg);d="undefined"!==typeof d?d:"Please confirm action";e="undefined"!==typeof a.heading?a.heading:"Are you sure?";f="undefined"!==typeof a.errorMsg?a.errorMsg:"";a="undefined"!==typeof a.dialog?a.dialog:"confirm";c="undefined"!==typeof c?c:{};c.posButton=c.posButton||"Confirm";c.negButton=c.negButton||"Cancel";c.posAction=c.posAction||function(){return false};c.negAction=c.negAction||function(){return false};
c.beforeAction=c.beforeAction||function(){};g=$("#dialog-"+a);g.find(".modal-header h3").text(e);g.find(".modal-body .msg").html(d).capitalizeStart();g.find(".modal-body .alert-error").html(f).show();f||g.find(".modal-body .alert-error").hide();g.modal({keyboard:!0,show:!0});g.on("shown",function(){c.beforeAction.call()});g.find("button.positive").on("click",function(){c.posAction.call();g.modal("hide")}).text(c.posButton);g.find("button.negative").on("click",function(){c.negAction.call();g.modal("hide")}).text(c.negButton);
g.on("hide",function(){g.off("shown hidden hide");g.find("button.positive, button.negative").off("click")});g.on("hidden",function(){g.find(".modal-body .msg, .modal-body .alert-error, button").text("")});if("number"===typeof b){var h=b.toString();g.find(".self-destruct-timer").text(h);i=setInterval(function(){h--;g.find(".self-destruct-timer").text(h)},1E3);setTimeout(function(){clearInterval(i);g.find(".close").click()},1E3*b)}};
GUI.prototype.showLoadErrors=function(a,c){var b='<ul class="error-list"><li>'+a.join("</li><li>")+"</li></ul",d="* "+a.join("* "),e=1<a.length?"s":"",f=settings.supportEmail;this.alert("<p>Error"+e+" occured during the loading of this form. "+(c||"")+'</p><br/><p>Please contact <a href="mailto:'+f+"?subject=loading errors for: "+location.href+"&body="+d+'" target="_blank" >'+f+"</a> with the link to this page and the error message"+e+" below:</p>"+b,"Loading Error"+e)};
GUI.prototype.updateStatus={connection:function(){},edit:function(a){a?$("header #status-editing").removeClass().addClass("ui-icon ui-icon-pencil").attr("title","Form is being edited."):$("header #status-editing").removeClass().attr("title","")},support:function(){},offlineLaunch:function(a){$(".drawer #status-offline-launch").text(a?"Offline Launch: Yes":"Offline Launch: No")}};
GUI.prototype.fillHeight=function(a){var c=$(window).height(),b=$("header").outerHeight(!0),a=a.outerHeight()-a.height();return c-b-a};
GUI.prototype.positionPageAndBar=function(){console.log("positionPageAndBar called");var a,c;a=$("header");c=a.outerHeight();var b=$("#feedback-bar"),d=0<b.find("p").length?!0:!1,e=b.outerHeight(),f=$("#page"),g=this.pages.isShowing(),i=f.outerHeight();f.css({position:a.css("position")});if("fixed"!==a.css("position"))return d||b.hide(),g||f.hide(),!1;a=!d?0-e:c;c=!g?0-i:d?a+e:c;b.css("top",a);f.css("top",c)};
GUI.prototype.setSettings=function(a){var c,b=this;console.log("gui updateSettings() started");$.each(a,function(a,e){c=e?b.pages.get("settings").find('input[name="'+a+'"][value="'+e+'"]'):b.pages.get("settings").find('input[name="'+a+'"]');0<c.length&&c.attr("checked",e?!0:!1).trigger("change")})};
GUI.prototype.parseFormlist=function(a,c,b){var d,e="";if($.isEmptyObject(a))c.addClass("empty"),b||(e='<p class="alert alert-error">Error occurred during creation of form list or no forms found</p>');else{for(d in a)e+='<li><a class="btn btn-block btn-info" id="'+d+'" title="'+a[d].title+'" href="'+a[d].url+'" data-server="'+a[d].server+'" >'+a[d].name+"</a></li>";c.removeClass("empty")}c.find("ul").empty().append(e)};function Print(){this.setStyleSheet();this.setDpi()}
Print.prototype.setDpi=function(){var a,c=document.body.appendChild(document.createElement("DIV"));c.style.width="1in";c.style.padding="0";a=c.offsetWidth;c.parentNode.removeChild(c);this.dpi=a};Print.prototype.setStyleSheet=function(){this.styleSheet=this.getStyleSheet();this.$styleSheetLink=$('link[media="print"]:eq(0)')};Print.prototype.getStyleSheet=function(){for(var a=0;a<document.styleSheets.length;a++)if("print"===document.styleSheets[a].media.mediaText)return document.styleSheets[a];return null};
Print.prototype.styleToAll=function(){this.styleSheet||this.setStyleSheet();this.styleSheet.media.mediaText="all";this.$styleSheetLink.attr("media","all")};Print.prototype.styleReset=function(){this.styleSheet.media.mediaText="print";this.$styleSheetLink.attr("media","print")};Print.prototype.printForm=function(){this.removePageBreaks();this.removePossiblePageBreaks();this.styleToAll();this.addPageBreaks();this.styleReset();window.print()};Print.prototype.removePageBreaks=function(){$(".page-break").remove()};
Print.prototype.removePossiblePageBreaks=function(){$(".possible-break").remove()};
Print.prototype.addPossiblePageBreaks=function(){var a=$("<hr>",{"class":"possible-break"});this.removePossiblePageBreaks();$("form.jr").before(a.clone()).after(a.clone()).find("fieldset>legend, label:not(.geo)>input:not(input:radio, input:checkbox), label>select, label>textarea, .trigger>*, h4>*, h3>*, .jr-appearance-field-list>*").parent().each(function(){var c,b;c=$(this);return(b=c.prev().get(0))&&("H3"===b.nodeName||"H4"===b.nodeName)||$(b).hasClass("repeat-number")||0<c.parents("#jr-calculated-items, #jr-preload-items").length||
0<c.parents(".jr-appearance-field-list").length?null:c.before(a.clone())});$(".possible-break").each(function(){if($(this).prev().hasClass("possible-break"))return $(this).remove()})};
Print.prototype.addPageBreaks=function(){var a,c,b,d,e,f,g,i;g=9.5*this.dpi;d=function(a,b){this.begin=$(a);this.begin_top=this.begin.offset().top;this.end=$(b);this.end_top=this.end.offset().top;this.h=this.end_top-this.begin_top;if(0>this.h)throw console.debug("begin (top: "+this.begin_top+")",a),console.debug("end (top: "+this.end_top+")",b),Error("A question group has an invalid height.");};d.prototype.break_before=function(){var a,b;b=(a=this.begin.prev().get(0))?["after",a]:["before",this.begin.parent().get(0)];
a=b[0];return $(b[1])[a]("<hr class='page-break' />")};this.removePageBreaks();this.addPossiblePageBreaks();b=$(".possible-break");c=[];for(a=1;a<b.length;a++)c.push(new d(b[a-1],b[a]));d=0;b=[];a=[];f=0;for(i=c.length;f<i;f++)e=c[f],d+e.h>g?(a.push(b),b=[e],d=e.h):(b.push(e),d+=e.h);a.push(b);console.debug("pages: ",a);g=1;for(b=a.length;g<b;g++)c=a[g],0<c.length&&c[0].break_before();return $(".possible-break").remove()};/*
 Copyright 2012 Martijn van de Rijdt & Modilabs

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
function Form(a,c,b){function d(a){function b(a,m,q){this.originalSelector=a;this.selector="string"===typeof a&&0<a.length?a:"*";this.filter=q="undefined"!==typeof q&&null!==q?q:{};this.filter.noTemplate="undefined"!==typeof q.noTemplate?q.noTemplate:!0;this.filter.onlyLeaf="undefined"!==typeof q.onlyLeaf?q.onlyLeaf:!1;this.filter.onlyTemplate="undefined"!==typeof q.onlyTemplate?q.onlyTemplate:!1;this.filter.noEmpty="undefined"!==typeof q.noEmpty?q.noEmpty:!1;this.index=m;0<c.find("model>instance").length&&
(this.selector="*"!==this.selector&&0!==this.selector.indexOf("/")&&d.instanceSelectRegEx.test(this.selector)?this.selector.replace(d.instanceSelectRegEx,"model > instance#$1"):"model > instance:eq(0) "+this.selector)}var c,d=this;this.instanceSelectRegEx=/instance\([\'|\"]([^\/:\s]+)[\'|\"]\)/g;a=a.replace(/xmlns\=\"[a-zA-Z0-9\:\/\.]*\"/g,"");this.xml=$.parseXML(a);this.$=c=$(this.xml);XPathJS.bindDomLevel3XPath();this.node=function(a,m,c){return new b(a,m,c)};b.prototype.get=function(){var a,b;
a=!0===this.filter.onlyTemplate?c.xfind(this.selector).filter("[template]"):!0===this.filter.noTemplate?c.xfind(this.selector).not("[template], [template] *"):c.xfind(this.selector);!0===this.filter.noEmpty?a=a.filter(function(){b=$(this).text();return 0===$(this).children().length&&0<$.trim(b).length}):!0===this.filter.onlyLeaf&&(a=a.filter(function(){return 0===$(this).children().length}));return a="undefined"!==typeof this.index&&null!==this.index?a.eq(this.index):a};b.prototype.setVal=function(a,
b,m){var c,d;c=this.getVal()[0];d="undefined"!==typeof a&&null!==a?$.isArray(a)?a.join(" "):a.toString():"";d=this.convert(d,m);a=this.get();if(1===a.length&&$.trim(d.toString())!==$.trim(c.toString()))return a.text(d),b=this.validate(b,m),h.trigger("dataupdate",a.prop("nodeName")),"binary"===m&&(0<d.length?a.attr("type","file"):a.removeAttr("type")),b;if(1<a.length)return console.error("nodeset.setVal expected nodeset with one node, but received multiple"),null;0===a.length&&console.error("Data node: "+
this.selector+" with null-based index: "+this.index+" not found!");return null};b.prototype.getVal=function(){var a=[];this.get().each(function(){a.push($(this).text())});return a};b.prototype.clone=function(a){var b,m;b=this.get();a=a||b;1===b.length&&1===a.length?(b.clone().insertAfter(a).find("*").addBack().removeAttr("template"),m=[b.prop("nodeName")],b.find("*").each(function(){m.push($(this).prop("nodeName"))}),h.trigger("dataupdate",m.join(","))):console.error("node.clone() function did not receive origin and target nodes")};
b.prototype.remove=function(){var a=this.get();0<a.length?(a.remove(),h.trigger("dataupdate",a.prop("nodeName"))):console.error("could not find node "+this.selector+" with index "+this.index+" to remove ")};b.prototype.convert=function(a,b){return""===a.toString()?a:"undefined"!==typeof b&&null!==b&&"undefined"!==typeof this.types[b.toLowerCase()]&&"undefined"!==typeof this.types[b.toLowerCase()].convert?this.types[b.toLowerCase()].convert(a):a};b.prototype.validate=function(a,b){var m,c;m=this.getVal()[0];
if(""===m.toString())return!0;if("undefined"==typeof b||null===b||"undefined"==typeof this.types[b.toLowerCase()])b="string";m=this.types[b.toLowerCase()].validate(m);c="undefined"!==typeof a&&null!==a&&0<a.length?d.evaluate(a,"boolean",this.originalSelector,this.index):!0;return m&&c};b.prototype.types={string:{validate:function(){return!0}},select:{validate:function(){return!0}},select1:{validate:function(){return!0}},decimal:{validate:function(a){return!isNaN(a-0)&&null!==a?!0:!1}},"int":{validate:function(a){return!isNaN(a-
0)&&null!==a&&Math.round(a)==a?!0:!1}},date:{validate:function(a){return(a=/([0-9]{4})([\-]|[\/])([0-9]{2})([\-]|[\/])([0-9]{2})/.exec(a))&&6===a.length?"Invalid Date"!==(new Date(Number(a[1]),Number(a[3])-1,Number(a[5]))).toString():!1},convert:function(a){var b=/([0-9]{4})([\-]|[\/])([0-9]{2})([\-]|[\/])([0-9]{2})/.exec(a),m=new Date(a);"Invalid Date"==(new Date(a)).toString()&&b&&(0<Number(b[1])&&0<=Number(b[3])&&12>Number(b[3])&&32>Number(b[5]))&&(m=new Date(Number(b[1]),Number(b[3])-1,Number(b[5])));
return m.getUTCFullYear().toString().pad(4)+"-"+(m.getUTCMonth()+1).toString().pad(2)+"-"+m.getUTCDate().toString().pad(2)}},datetime:{validate:function(a){console.debug("datetime validation function received: "+a+" type:"+typeof a);return"Invalid Date"!==(new Date(a.toString())).toString()||"Invalid Date"!==(new Date(this.convert(a.toString()))).toString()},convert:function(a){var b=/([0-9]{4}\-[0-9]{2}\-[0-9]{2})([T]|[\s])([0-9]){2}:([0-9]){2}([0-9:.]*)(\+|\-)([0-9]{2}):([0-9]{2})$/,m=/([0-9]{4}\-[0-9]{2}\-[0-9]{2})([T]|[\s])([0-9]){2}:([0-9]){2}([0-9:.]*)(\+|\-)([0-9]{2})$/;
if("Invalid Date"!==(new Date(a)).toString()&&b.test(a))return a;if("Invalid Date"==(new Date(a)).toString()&&m.test(a))return a+":00";a=new Date(a);return"Invalid Date"!==a.toString()?a.toISOLocalString():a.toString()}},time:{validate:function(a){var b=new Date,a=a.toString().split(":");if(2>a.length)return!1;a[2]=a[2]?Number(a[2].toString().split(".")[0]):0;return 24>a[0]&&0<=a[0]&&60>a[1]&&0<=a[1]&&60>a[2]&&0<=a[2]&&"Invalid Date"!==b.toString()},convert:function(a){var b=a.toString().split(":");
$.each(b,function(a,m){b[a]=m.toString().pad(2)});return b.join(":")}},barcode:{validate:function(){return!0}},geopoint:{validate:function(a){a=a.toString().split(" ");return""!==a[0]&&-90<=a[0]&&90>=a[0]&&""!==a[1]&&-180<=a[1]&&180>=a[1]&&("undefined"==typeof a[2]||!isNaN(a[2]))&&("undefined"==typeof a[3]||!isNaN(a[3])&&0<=a[3])},convert:function(a){return $.trim(a.toString())}},binary:{validate:function(){return!0}}}}function e(a){this.$=h=$(a);this.branch=new this.Branch(this)}var f,g,i,h,j,p,
l=[];this.ex=function(a,b,c,d){return f.evaluate(a,b,c,d)};this.sfv=function(){return i.setAllVals()};this.Data=function(a){return new d(a)};this.getDataO=function(){return f};this.getDataEditO=function(){return g.get()};this.getInstanceID=function(){return f.getInstanceID()};this.Form=function(a){return new e(a)};this.getFormO=function(){return i};this.init=function(){j=$(a).clone().appendTo("<original></original>");f=new d(c);i=new e(a);f.init();"undefined"!==typeof b&&(b&&0<b.length)&&(g=new d(b),
g.init(),f.load(g));p=0<$(a).find(".jr-repeat").length;i.init();0<l.length&&console.error("loadErrors: ",l);return l};this.getDataStr=function(a,b,c){return f.getStr(a,b,c)};this.getRecordName=function(){return i.recordName.get()};this.setRecordName=function(a){return i.recordName.set(a)};this.getRecordStatus=function(){return i.recordStatus.get()};this.setRecordStatus=function(a){return i.recordStatus.set(a)};this.setEditStatus=function(a){return i.editStatus.set(a)};this.getEditStatus=function(){return i.editStatus.get()};
this.getName=function(){return h.find("#form-title").text()};this.resetHTML=function(){$("#form-languages").remove();h.replaceWith(j)};this.validateForm=function(){return i.validateAll()};this.isValid=function(){return i.isValid()};d.prototype.init=function(){var a;this.node(null,null,{noEmpty:!0,noTemplate:!1}).get().each(function(){a=$(this).text();$(this).text($.trim(a))});this.cloneAllTemplates()};d.prototype.getInstanceID=function(){return this.node(":first>meta>instanceID").getVal()[0]};d.prototype.load=
function(a){var b,c,d,e,f,g,C,r,k,n,o=this,s={noTemplate:!0,noEmpty:!0};b=a.node(null,null,s).get();console.debug("nodes to load: ",b);this.node(null,null,s).get().each(function(){$(this).text("")});b.each(function(){var b=$(this).prop("nodeName");e=i.generateName($(this));c=a.node(e).get().index($(this));f=$(this).text();C=h.find('[name="'+e+'"]').eq(0);d=0<C.length?i.input.getXmlType(C):"string";g=o.node(e,c);r=g.get();1<r.length?console.error("Found multiple nodes with path: "+e+" and index: "+
c):1===r.length?g.setVal(f,null,d):0<o.node(e,c,{noTemplate:!1}).get().length?(k=o.node(e,0,{noTemplate:!1}).get().closest("[template]"),o.cloneTemplate(i.generateName(k),c-1),g=o.node(e,c),1===g.get().length?g.setVal(f,null,d):(n="Error occured trying to clone template node to set the repeat value of the instance to be edited.",console.error(n),l.push(n))):1===$(this).parent("meta").length&&1===o.node(i.generateName($(this).parent("meta")),0).get().length?0===o.node(":first > meta > "+b,0).get().length?
(console.debug("cloning this direct child of <meta>"),$(this).clone().appendTo(o.node(":first > meta").get())):(n="Found duplicate meta node ("+b+")!",console.error(n),l.push(n)):(n="Did not find form node with path: "+e+" and index: "+c+" so failed to load data.",console.error(n),l.push(n))});b=this.node("*>meta>instanceID");1!==b.get().length?(n="InstanceID node in default instance error (found "+b.get().length+" instanceID nodes)",console.error(n),l.push(n)):(1!==this.node("*>meta>deprecatedID").get().length&&
(s=$.parseXML("<deprecatedID/>").documentElement,$(s).appendTo(this.node("*>meta").get())),this.node("*>meta>deprecatedID").setVal(b.getVal()[0],null,"string"),b.setVal("",null,"string"))};d.prototype.cloneTemplate=function(a,b){var c,d,e=this.node(a,0,{onlyTemplate:!0}),e=0===e.get().length?this.node(a,0):e;d=e.get().prop("nodeName");c=this.node(a,b).get();1===e.get().length&&1===c.length&&c.next().prop("nodeName")!==d?e.clone(c):c.next().prop("nodeName")!==d&&console.error("Could not find template node and/or node to insert the clone after")};
d.prototype.cloneAllTemplates=function(a){var b=this;if("undefined"==typeof a||0===a.length)a=this.$.find(":first");a.children("[template]").each(function(){"undefined"==typeof $(this).parent().attr("template")&&0===$(this).siblings($(this).prop("nodeName")).not("[template]").length&&$(this).clone().insertAfter($(this)).find("*").addBack().removeAttr("template")});a.children().not("[template]").each(function(){b.cloneAllTemplates($(this))})};d.prototype.get=function(){return this.$||null};d.prototype.getXML=
function(){return this.xml||null};d.prototype.getStr=function(a,b,c){a=(new XMLSerializer).serializeToString(this.getInstanceClone(a,b,c)[0]);return a=a.replace(/\t/g,"")};d.prototype.getInstanceClone=function(a,b,c){b=c?this.$.find(":first").clone():this.node("> *:first").get().clone();return a?b:b.find("[template]").remove().end()};d.prototype.makeBugCompliant=function(a,b,c){var d,e;d=0<h.find('[name="'+b+'"][type="radio"]').length&&0<c?"data-name":"name";e=i.input.getWrapNodes(h.find("["+d+'="'+
b+'"]')).eq(c).parents(".jr-repeat");for(b=0;b<e.length;b++)c=e.eq(b).attr("name"),d=e.eq(b).siblings('[name="'+c+'"]').addBack().index(e.eq(b)),console.log("calculated repeat 0-based index: "+d),a=a.replace(c,c+"["+(d+1)+"]");return a};d.prototype.evaluate=function(a,b,c,e){var f,g,B,i,r,k,n,o;console.debug("evaluating expr: "+a+" with context selector: "+c+", 0-based index: "+e+" and result type: "+b);b=b||"any";e=e||0;a=a.trim();B=new d(this.getStr(!1,!1));if(this.instanceSelectRegEx.test(a)){i=
a.match(this.instanceSelectRegEx);for(f=0;f<i.length;f++)r=i[f].match(/[\'|\"]([^\'']+)[\'|\"]/)[1],a=a.replace(i[f],'/node()/instance[@id="'+r+'"]'),this.$.find(":first>instance#"+r).clone().appendTo(B.$.find(":first"))}"undefined"!==typeof c&&null!==c?(f=B.$.xfind(c).eq(e)[0],0<h.find('[name="'+c+'"]:eq(0)').closest(".jr-repeat").length&&(a=this.makeBugCompliant(a,c,e))):f=B.getXML();c={"0":["any","ANY_TYPE"],1:["number","NUMBER_TYPE","numberValue"],2:["string","STRING_TYPE","stringValue"],3:["boolean",
"BOOLEAN_TYPE","booleanValue"],7:["nodes","ORDERED_NODE_SNAPSHOT_TYPE"],9:["node","FIRST_ORDERED_NODE_TYPE"]};for(k in c)if(k=Number(k),c[k][0]==b)break;else k=0;a=a.replace(/&lt;/g,"<");a=a.replace(/&gt;/g,">");a=a.replace(/&quot;/g,'"');try{n=document.evaluate(a,f,null,k,null);if(0===k){for(k in c)if(k=Number(k),k==Number(n.resultType))return n=0<k&&4>k?n[c[k][2]]:n,console.debug("evaluated "+a+" to: ",n),n;console.error("Expression: "+a+" did not return any boolean, string or number value as expected")}else if(7===
k){o=$();for(g=0;g<n.snapshotLength;g++)o=o.add(n.snapshotItem(g));return o}console.debug("evaluated "+a+" to: "+n[c[k][2]]);return n[c[k][2]]}catch(s){return a="Error occurred trying to evaluate: "+a+", message: "+s.message,console.error(a),$(document).trigger("xpatherror",a),l.push(a),null}};e.prototype.init=function(){var a;if("undefined"==typeof f||!(f instanceof d))return console.error("variable data needs to be defined as instance of DataXML");this.preloads.init(this);Modernizr.touch||(h.find(".jr-hint ~ input, .jr-hint ~ select, .jr-hint ~ textarea").before('<span class="hint" ><i class="icon-question-sign"></i></span>'),
h.find("legend > .jr-hint").parent().find("span:last-child").after('<span class="hint" ><i class="icon-question-sign"></i></span>'),h.find(".trigger > .jr-hint").parent().find("span:last").after('<span class="hint" ><i class="icon-question-sign"></i></span>'));h.find("select, input, textarea").not('[type="checkbox"], [type="radio"], [readonly], #form-languages').before($("<br/>"));h.find('input[type="radio"]').each(function(){a=$(this).attr("name");$(this).attr("data-name",a)});this.setLangs();this.repeat.init(this);
this.itemsetUpdate();this.setAllVals();this.widgets.init();this.bootstrapify();this.grosslyViolateStandardComplianceByIgnoringCertainCalcs();this.calcUpdate();this.branch.init();this.outputUpdate();this.setHints();this.setEventHandlers();this.editStatus.set(!1)};e.prototype.checkForErrors=function(){var a,b=[],c,d,e,g,i,l,r,k,n,o,s,j,p,x,t,v,u,z,y,A;k=h.find("#stats");if(0<k.length){a=parseInt(k.find('[id="jrItem"]').text(),10);c=parseInt(k.find('[id="jrInput"]').text(),10);d=parseInt(k.find('[id="jrItemset"]').text(),
10);e=parseInt(k.find('[id="jrUpload"]').text(),10);g=parseInt(k.find('[id="jrTrigger"]').text(),10);i=parseInt(k.find('[id="jrConstraint"]').text(),10);l=parseInt(k.find('[id="jrRelevant"]').text(),10);r=parseInt(k.find('[id="jrCalculate"]').text(),10);k=parseInt(k.find('[id="jrPreload"]').text(),10);n=h.find('input[type="radio"]').length;o=h.find('input[type="checkbox"]').length;h.find("select:not(#form-languages)");s=h.find(".itemset-template").length;j=h.find('select:not(#form-languages) > option[value!=""]').length;
p=h.find('textarea, input:not([type="radio"],[type="checkbox"])').length;x=h.find(".trigger").length;t=h.find('[data-relevant]:not([type="radio"],[type="checkbox"])').length;v=h.find('input[data-relevant][type="radio"],input[data-relevant][type="checkbox"]').parent().parent("fieldset").length;u=h.find('[data-constraint]:not([type="radio"],[type="checkbox"])').length;z=h.find('input[data-constraint][type="radio"],input[data-constraint][type="checkbox"]').parent().parent("fieldset").length;y=h.find("[data-calculate]").length;
A=h.find("#jr-preload-items input").length;0===d&&a!==j+n+o&&console.error(" total number of option fields differs between XML form and HTML form");d!==s&&console.error(" total number of itemset fields differs between XML form ("+d+") and HTML form ("+s+")");c+e!==p-y-A&&console.error(" total number of input/upload fields differs between XML form and HTML form");g!=x&&console.error(" total number of triggers differs between XML form and HTML form");l!=t+v&&console.error(" total number of branches differs between XML form and HTML form (not a problem if caused by obsolete bindings in xml form)");
i!=u+z&&console.error(" total number of constraints differs between XML form ("+i+") and HTML form ("+(u+z)+")(not a problem if caused by obsolete bindings in xml form). Note that constraints on &lt;trigger&gt; elements are ignored in the transformation and could cause this error too.");r!=y&&console.error(" total number of calculated items differs between XML form and HTML form");k!=A&&console.error(" total number of preload items differs between XML form and HTML form");h.find("[name]").each(function(){$.inArray($(this).attr("name"),
b)&&b.push($(this).attr("name"))});for(a=0;a<b.length;a++)1>f.node(b[a]).get().length&&console.error("Found name attribute: "+b[a]+" that does not have a corresponding data node. Transformation error or XML form error (relative nodesets perhaps?")}};e.prototype.input={getWrapNodes:function(a){var b=this.getInputType(a.eq(0));return"radio"==b||"checkbox"==b?a.closest(".restoring-sanity-to-legends"):"fieldset"==b?a:a.parent("label")},getProps:function(a){return 1!==a.length?console.error("getProps(): no input node provided or multiple"):
{path:this.getName(a),ind:this.getIndex(a),inputType:this.getInputType(a),xmlType:this.getXmlType(a),constraint:a.attr("data-constraint"),relevant:a.attr("data-relevant"),val:this.getVal(a),required:void 0!==a.attr("required")&&0===a.parents(".jr-appearance-label").length?!0:!1,enabled:this.isEnabled(a),multiple:this.isMultiple(a)}},getInputType:function(a){var b;if(1!==a.length)return"";b=a.prop("nodeName").toLowerCase();return"input"==b?0<a.attr("type").length?a.attr("type").toLowerCase():console.error("<input> node has no type"):
"select"==b?"select":"textarea"==b?"textarea":"fieldset"==b?"fieldset":console.error("unexpected input node type provided")},getXmlType:function(a){return 1!==a.length?console.error("getXMLType(): no input node provided or multiple"):a.attr("data-type-xml")},getName:function(a){return 1!==a.length?console.error("getName(): no input node provided or multiple"):a.attr("data-name")||a.attr("name")||console.error("input node has no name")},getIndex:function(a){var b,c,d;if(1!==a.length)return console.error("getIndex(): no input node provided or multiple");
b=this.getInputType(a);c=this.getName(a);d=this.getWrapNodes(a);return("radio"===b&&c!==a.attr("name")?this.getWrapNodes(h.find('[data-name="'+c+'"]')):this.getWrapNodes(h.find('[name="'+c+'"]'))).index(d)},isMultiple:function(a){return"checkbox"==this.getInputType(a)||void 0!==a.attr("multiple")?!0:!1},isEnabled:function(a){return!(a.prop("disabled")||0<a.parents("fieldset:disabled").length)},getVal:function(a){var b,c=[],d;if(1!==a.length)return console.error("getVal(): no inputNode provided or multiple");
b=this.getInputType(a);d=this.getName(a);return"radio"==b?this.getWrapNodes(a).find("input:checked").val()||"":"checkbox"==b?(this.getWrapNodes(a).find('input[name="'+d+'"]:checked').each(function(){c.push($(this).val())}),c):!a.val()?"":$.isArray(a.val())?a.val().join(" ").trim():a.val().trim()},setVal:function(a,b,c){b=b||0;if("radio"==this.getInputType(h.find('[data-name="'+a+'"]').eq(0)))c=this.getWrapNodes(h.find('[data-name="'+a+'"]')).eq(b).find('input[value="'+c+'"]'),c.prop("checked",!0);
else{a=this.getWrapNodes(h.find('[name="'+a+'"]')).eq(b).find("input, select, textarea");b=this.getInputType(a.eq(0));if("file"===b)return a.eq(0).attr("data-loaded-file-name",c),!1;if("date"===b||"datetime"===b)c=f.node().convert(c,b),console.debug("converting date before setting input field to: "+c);!0===this.isMultiple(a.eq(0))&&(c=c.split(" "));a.val(c)}}};e.prototype.setAllVals=function(){var a,b,c,d=this;f.node(null,null,{noEmpty:!0}).get().each(function(){try{c=$(this).text(),b=d.generateName($(this)),
a=f.node(b).get().index($(this)),console.debug("calling input.setVal with name: "+b+", index: "+a+", value: "+c),d.input.setVal(b,a,c)}catch(e){l.push("Could not load input field value with name: "+b+" and value: "+c)}})};e.prototype.setLangs=function(){var a,b,c,d,e=this,f=h.find("#form-languages").attr("data-default-lang"),g=$(".form-language-selector");$("#form-languages").detach().appendTo(g);if(!f||""===f)f=$("#form-languages option:eq(0)").attr("value");console.debug("default language is: "+
f);$("#form-languages").val(f);2>$("#form-languages option").length?g.hide():$("#form-languages").change(function(f){console.debug("form-language change event detected!");f.preventDefault();a=$(this).val();$("#form-languages option").removeClass("active");$(this).addClass("active");h.find("[lang]").removeClass("active").filter('[lang="'+a+'"], [lang=""]').addClass("active");h.find("select > option").not('[value=""]').each(function(){c=$(this).text();b=$(this).attr("value");d=$(this).parent("select").siblings(".jr-option-translations").children('.active[data-option-value="'+
b+'"]').text().trim();d="undefined"!==typeof d&&0<d.length?d:c;$(this).text(d)});h.find("legend span.active:not(.jr-hint, .jr-constraint-msg), label span.active:not(.jr-hint, .jr-constraint-msg)").each(function(){0===$(this).text().trim().length&&$(this).text("[MISSING TRANSLATION]")});e.setHints();h.trigger("changelanguage")})};e.prototype.setHints=function(a){if(!Modernizr.touch){var b,c,d;(a&&a.outputsOnly&&a.outputsOnly?h.find("*>.jr-hint>.jr-output").parent():h.find("*>.jr-hint")).parent().each(function(){d=
"label"!==$(this).prop("nodeName").toLowerCase()&&"fieldset"!==$(this).prop("nodeName").toLowerCase()?$(this).parent("fieldset"):$(this);c=d.find(".hint");b=$(this).find(".jr-hint.active").text().trim();0<b.length?c.attr("title",b):c.removeAttr("title");c.tooltip("fixTitle").tooltip({placement:"right"})})}};e.prototype.editStatus={set:function(a){h.attr("data-edited",Boolean(a));h.trigger("edit",a)},get:function(){return"true"===h.attr("data-edited")?!0:!1}};e.prototype.recordName={set:function(a){h.attr("data-stored-with-key",
a);h.find("h2 span").text(a)},get:function(){return h.attr("data-stored-with-key")||null},reset:function(){h.removeAttr("data-stored-with-key")}};e.prototype.recordStatus={set:function(a){h.attr("data-stored-final",a.toString())},get:function(){return"true"===h.attr("data-stored-final")?!0:!1},reset:function(){h.removeAttr("data-stored-final")}};e.prototype.Branch=function(a){this.init=function(){this.update()};this.update=function(b){var c,d,e,f,g,i,l,k,n,o=null,j={},D=[],E=this,x=0,t;i="undefined"!==
typeof b?b.split(","):[];l=0<i.length?[]:["[data-relevant]"];for(b=0;b<i.length;b++)l.push('[data-relevant*="'+i[b]+'"]');t=p&&0<h.find(".jr-repeat.clone").length?!0:!1;h.find(l.join()).each(function(){-1===$.inArray($(this).attr("name"),D)&&(e=d=c=void 0,c=$(this).attr("data-relevant"),d=a.input.getName($(this)),f=$(this).closest(".jr-branch"),1!==f.length?0===$(this).parents("#jr-calculated-items").length&&console.error("could not find branch node for ",$(this)):(k=t&&0<f.closest(".jr-repeat").length?
!0:!1,e=(n=t&&0<f.closest(".jr-repeat.clone").length?!0:!1)?a.input.getIndex($(this)):0,-1===c.indexOf("..")&&!k&&(o=c),o&&"undefined"!==typeof j[o]?g=j[o]:(g=E.evaluate(c,d,e),x++,j[o]=g),k||D.push($(this).attr("name")),E.process(f,g)))});return!0};this.evaluate=function(a,b,c){return f.evaluate(a,"boolean",b,c)};this.process=function(a,b){!0===b?(console.log("going to enable ",a),this.enable(a)):(console.log("going to disable ",a),this.disable(a))};this.selfRelevant=function(a){return!a.hasClass("disabled")&&
!a.hasClass("pre-init")};this.ancestorRelevant=function(a){return 0===a.parents(".disabled").length};this.enable=function(b){var c,d=this;this.selfRelevant(b)||(console.debug("enabling branch with name: "+b.attr("name")),b.removeClass("disabled pre-init").show(250,function(){d.ancestorRelevant(b)&&a.widgets.tableWidget(b)}),c=b.prop("nodeName").toLowerCase(),"label"==c?b.children("input, select, textarea").prop("disabled",!1):b.prop("disabled",!1))};this.disable=function(b){var c=b.prop("nodeName").toLowerCase(),
d=b.hasClass("pre-init");if(this.selfRelevant(b)||d)console.debug("disabling branch"),b.addClass("disabled"),"undefined"!==typeof settings&&("undefined"!==typeof settings.showBranch&&!settings.showBranch)&&b.hide(250),d?b.removeClass("pre-init"):(b.clearInputs("change"),b.find(".invalid-required, .invalid-constraint").find("input, select, textarea").each(function(){a.setValid($(this))})),"label"==c?b.children("input, select, textarea").prop("disabled",!0):b.prop("disabled",!0)}};e.prototype.itemsetUpdate=
function(a){console.log("updating itemsets");var b,c,d,e=this,g=[],i=!1,l={};"undefined"==typeof a?g=[".itemset-template"]:$.each(a.split(","),function(a,b){g.push('.itemset-template[data-items-path*="'+b+'"]')});g=g.join(",");b=p&&0<h.find(".jr-repeat.clone").length?!0:!1;h.find(g).each(function(){var a,m,h,g,w,j=$(this),p={},x=j.data(),t=$(this).prop("nodeName").toLowerCase();w="label"===t?$(this).children("input").eq(0):$(this).parent("select");var v=j.closest("label, select").siblings(".itemset-labels"),
u=j.attr("data-items-path"),z=v.attr("data-label-type"),y=v.attr("data-label-ref"),A=v.attr("data-value-ref");g=e.input.getName(w);c=b&&0<w.closest(".jr-repeat").length?!0:!1;w=(d=b&&0<w.closest(".jr-repeat.clone").length?!0:!1)?e.input.getIndex(w):0;"undefined"!==typeof l[u]?(console.debug("using cached itemset items result for "+u),g=l[u]):(console.debug("no cache for "+u+", need to evaluate XPath"),g=f.evaluate(u,"nodes",g,w),c||(l[u]=g));p.length=g.length;p.text=g.text();p.length===x.length&&
p.text===x.text?console.debug("itemset unchanged"):(j.data(p),$(this).closest("label > select, fieldset > label").parent().clearInputs("change").find(t).not(j).remove(),$(this).parent("select").siblings(".jr-option-translations").empty(),g.each(function(){a=$("<root/>");j.clone().appendTo(a).removeClass("itemset-template").addClass("itemset").removeAttr("data-items-path");m=z==="itext"?v.find('[data-itext-id="'+$(this).children(y).text()+'"]').clone():$('<span class="active" lang="">'+$(this).children(y).text()+
"</span>");h=$(this).children(A).text();a.find("[value]").attr("value",h);if(t==="label"){a.find("input").after(m);v.before(a.find(":first"))}else if(t==="option"){i=true;m.length===1&&a.find("option").text(m.text());m.attr("data-option-value",h).attr("data-itext-id","").appendTo(v.siblings(".jr-option-translations"));j.siblings().addBack().last().after(a.find(":first"))}}))});console.debug("need to update langs: "+i);i&&$("#form-languages").trigger("change")};e.prototype.outputUpdate=function(a){var b,
c,d,e,g,i,l,r,k=!1,j={},o="",s=this;c="undefined"!==typeof a?a.split(","):[];d=0<c.length?[]:[".jr-output[data-value]"];for(a=0;a<c.length;a++)d.push('.jr-output[data-value*="'+c[a]+'"]');e=p&&0<h.find(".jr-repeat.clone").length?!0:!1;h.find(":not(:disabled) span.active").find(d.join()).each(function(){b=$(this).attr("data-value");l=s.input.getName($(this).closest("fieldset"));g=e&&0<$(this).closest(".jr-repeat").length;r=(i=e&&0<$(this).closest(".jr-repeat.clone").length)?s.input.getIndex($(this).closest("fieldset")):
0;"undefined"!==typeof j[b]?o=j[b]:(o=f.evaluate(b,"string",l,r),g||(j[b]=o));$(this).text!==o&&($(this).text(o),k=!0)});k&&this.setHints({outputsOnly:!0})};e.prototype.grosslyViolateStandardComplianceByIgnoringCertainCalcs=function(){var a=h.find('[name$="/meta/instanceID"][data-calculate]');0<a.length&&(console.debug("Found meta/instanceID with binding that has a calculate attribute and removed this calculation. It ain't right!"),a.removeAttr("data-calculate"))};e.prototype.calcUpdate=function(a){var b,
c,d,e,g,i,l,r,k;r="undefined"!==typeof a?a.split(","):[];k=0<r.length?[]:["input[data-calculate]"];for(a=0;a<r.length;a++)k.push('input[data-calculate*="'+r[a]+'"], input[data-relevant*="'+r[a]+'"]');h.find("#jr-calculated-items").find(k.join()).each(function(){b=$(this).attr("name");c=$(this).attr("data-calculate");d=$(this).attr("data-type-xml");l=$(this).attr("data-constraint");i=(e=(g=$(this).attr("data-relevant"))?f.evaluate(g,"boolean",b):!0)?f.evaluate(c,"string",b,null):"";f.node(b,null).setVal(i,
l,d)})};e.prototype.bootstrapify=function(){h.addClass("clearfix").find("label, legend").each(function(){var a=$(this);0===a.siblings("legend").length&&(0===a.parent("#jr-calculated-items, #jr-preload-items").length&&0===a.find(".jr-constraint-msg").length&&("legend"==a.prop("nodeName").toLowerCase()||a.children("input.ignore").length!==a.children("input").length||a.children("select.ignore").length!==a.children("select").length||a.children("textarea.ignore").length!==a.children("textarea").length))&&
a.prepend('<span class="jr-constraint-msg active" lang="">Value not allowed</span>')});h.find(".trigger").addClass("alert alert-block");h.find(".jr-constraint-msg").parent().each(function(){var a=$(this).find(".jr-constraint-msg").detach();$(this).closest("label, fieldset").append(a);a.after('<span class="jr-required-msg active" lang="">This field is required</span>')});Modernizr.touch||$(".form-header [title]").tooltip({placement:"bottom"})};e.prototype.widgets={init:function(a){this.repeat=a?!0:
!1;this.$group=a||h;this.readonlyWidget();this.pageBreakWidget();(!Modernizr.touch||!Modernizr.inputtypes.date)&&this.dateWidget();(!Modernizr.touch||!Modernizr.inputtypes.time)&&this.timeWidget();(!Modernizr.touch||!Modernizr.inputtypes.datetime)&&this.dateTimeWidget();Modernizr.touch?(this.mobileSelectWidget(),this.touchRadioCheckWidget(),this.samsungTab2DateBugWidget()):this.selectWidget();this.geopointWidget();this.tableWidget();this.spinnerWidget();this.sliderWidget();this.barcodeWidget();this.offlineFileWidget();
this.mediaLabelWidget();this.radioEventsWidget();this.radioCheckWidget();this.radioUnselectWidget()},radioEventsWidget:function(){h.on("click","label",function(){console.log("click label")});h.on("focus","label",function(){console.log("focus label")});h.on("click",'input[type="radio"], input[type="checkbox"]',function(){console.log("click input, checked:"+$(this).is(":checked"))});h.on("focus",'input[type="radio"], input[type="checkbox"]',function(){console.log("focus input, checked:"+$(this).is(":checked"))});
h.on("change",'input[type="radio"], input[type="checkbox"]',function(){console.log("change input, checked:"+$(this).is(":checked"))})},radioCheckWidget:function(){if(!this.repeat){var a;h.on("click",'input[type="radio"]:checked',function(){$(this).parent("label").siblings().removeAttr("data-checked").end().attr("data-checked","true")});h.on("click",'input[type="checkbox"]',function(){a=$(this).parent("label");$(this).is(":checked")?a.attr("data-checked","true"):a.removeAttr("data-checked")});h.find('input[type="radio"]:checked, input[type="checkbox"]:checked').parent("label").attr("data-checked",
"true")}},radioUnselectWidget:function(){this.repeat||(console.debug("initializing radio unselect widget"),h.on("click",'[data-checked]>input[type="radio"]',function(){console.debug("registered click event on label with data-checked attribute");$(this).prop("checked",!1).trigger("change").parent().removeAttr("data-checked")}))},touchRadioCheckWidget:function(){this.repeat||h.find("fieldset:not(.jr-appearance-compact, .jr-appearance-quickcompact, .jr-appearance-label, .jr-appearance-list-nolabel )").children("label").children('input[type="radio"], input[type="checkbox"]').parent("label").addClass("btn-radiocheck")},
samsungTab2DateBugWidget:function(){var a=/GT-P31[0-9]{2}.+AppleWebKit\/534\.30/;!this.repeat&&a.test(navigator.userAgent)&&(h.on("focus",'input[type="date"]',function(){var a=$(this).val(),a=10<a.length?a.substring(0,10):a;$(this).val(a);return!0}),console.debug("Samsung Tab 2 Native Browser Date Bug workaround initialized"))},dateWidget:function(){this.$group.find('input[type="date"]').each(function(){var a=$(this),b=$(this).parent("label"),c=b.hasClass("jr-appearance-month-year")?"year":b.hasClass("jr-appearance-year")?
"decade":"month",b=b.hasClass("jr-appearance-month-year")?"changeMonth":b.hasClass("jr-appearance-year")?"changeYear":"changeDate",d="year"===c?"yyyy-mm":"decade"===c?"yyyy":"yyyy-mm-dd",e=$('<div class="widget input-append date"><input class="ignore input-small" type="text" value="'+$(this).val()+'" placeholder="'+d+'" /><span class="add-on"><i class="icon-calendar"></i></span></div>'),g=e.find("input");a.next(".widget.date").remove();a.hide().after(e);g.on("change",function(){console.debug("fakedate input field change detected");
var b;b=$(this).val();0<b.length?(b="yyyy-mm"===d?b+"-01":"yyyy"===d?b+"-01-01":b,a.val(f.node().convert(b,"date")).trigger("change").blur(),b=new Date(b.split("-")[0],Number(b.split("-")[1])-1,b.split("-")[2]),e.datepicker("setDate",new Date(b))):a.val("").trigger("change").blur();return!1});g.on("focus blur",function(b){a.trigger(b.type)});e.datepicker({format:d,autoclose:!0,todayHighlight:!0,startView:c}).on(b,function(a){var b=$(a.currentTarget).data("datepicker");b.date=a.date;b.setValue();b.hide();
g.trigger("change")})})},timeWidget:function(){this.$group.find('input[type="time"]').each(function(){var a=$(this);$(this).parent("label");var b=$(this).val(),c=$('<div class="widget input-append bootstrap-timepicker-component"><input class="ignore timepicker-default input-small" type="text" value="'+b+'" placeholder="hh:mm" /><span class="add-on"><i class="icon-time"></i></span></div>'),d=c.find("input");a.next(".widget.bootstrap-timepicker-component").remove();a.hide().after(c);d.timepicker({defaultTime:0<
b.length?"value":"current",showMeridian:!1}).val(b);d.on("change",function(){console.debug("detected change event on fake time input");a.val($(this).val()).trigger("change").blur();return!1});d.on("focus blur",function(b){a.trigger(b.type)})})},dateTimeWidget:function(){this.$group.find('input[type="datetime"]').each(function(){function a(){if(0<f.val().length&&0<g.val().length){var c=f.val().split("-"),d=g.val().split(":");console.log("changing datetime");b.val((new Date(c[0],c[1]-1,c[2],d[0],d[1])).toISOLocalString()).trigger("change").blur()}else b.val("").trigger("change").blur()}
var b=$(this),c=(0<$(this).val().length?(new Date($(this).val())).toISOLocalString():"").split("T"),d=c[0],c=c[1]&&4<c[1].length?c[1].substring(0,5):"",d=$('<div class="input-append date" ><input class="ignore input-small" type="text" value="'+d+'" placeholder="yyyy-mm-dd"/><span class="add-on"><i class="icon-calendar"></i></span></div>'),e=$('<div class="input-append bootstrap-timepicker-component"><input class="ignore timepicker-default input-small" type="text" value="'+c+'" placeholder="hh:mm"/><span class="add-on"><i class="icon-time"></i></span></div>'),
f=d.find("input"),g=e.find("input");b.next(".widget.datetimepicker").remove();b.hide().after('<div class="datetimepicker widget" />');b.siblings(".datetimepicker").append(d).append(e);d.datepicker({format:"yyyy-mm-dd",autoclose:!0,todayHighlight:!0});g.timepicker({defaultTime:0<c.length?"value":"current",showMeridian:!1}).val(c);f.on("change changeDate",function(){a();return!1});g.on("change",function(){a();return!1});f.add(g).on("focus blur",function(a){b.trigger(a.type)})})},selectWidget:function(){this.$group.find("select").not("#form-languages").selectpicker();
if(!this.repeat)h.on("changelanguage",function(){h.find("select").selectpicker("update")})},mobileSelectWidget:function(){var a=function(a){var b=$.isArray(a.val())?a.val():[a.val()],c=[];console.log("mobileSelectWidget change event detected, values selected: ",b);for(var d=0;d<b.length;d++)c.push($(this).find('option[value="'+b[d]+'"]').text());a.siblings(".widget.mobileselect").remove();a.after('<span class="widget mobileselect">'+b.join(", ")+"</span>")};h.on("change","select[multiple]",function(){a($(this));
return!0});h.find("select[multiple]").each(function(){a($(this))})},pageBreakWidget:function(){this.repeat||h.find(".jr-appearance-page-break input[readonly]").parent("label").each(function(){var a='name="'+$(this).find("input").attr("name")+'"';$('<hr class="manual page-break" '+a+"></hr>").insertBefore($(this)).find("input").remove();$(this).remove()})},readonlyWidget:function(){this.repeat||h.find('input[readonly]:not([data-type-xml="geopoint"])').parent("label").each(function(){var a=$(this).html(),
b=$(this).find("input").attr("data-relevant"),c=b?" jr-branch pre-init":"",d='name="'+$(this).find("input").attr("name")+'"',b="undefined"!==typeof b?'data-relevant="'+b+'" '+d:d,d=$(this).find("input, select, textarea").val();$('<fieldset class="trigger'+c+'" '+b+"></fieldset>").insertBefore($(this)).append(a).append('<div class="note-value">'+d+"</div>").find("input").remove();$(this).remove()})},tableWidget:function(a){var b=a||h;setTimeout(function(){console.debug("setting table column widths");
b.parent().find(".jr-appearance-field-list .jr-appearance-list-nolabel, .jr-appearance-field-list .jr-appearance-label").parent().parent(".jr-appearance-field-list").each(function(){$(this).find(".jr-appearance-label label>img").parent().css("width","auto").toSmallestWidth();$(this).find("label").css("width","auto").toLargestWidth();$(this).find("legend").css("width","auto").toLargestWidth(35)})},50)},spinnerWidget:function(){},sliderWidget:function(){},geopointWidget:function(){this.$group.find('input[data-type-xml="geopoint"]').geopointWidget({touch:Modernizr.touch})},
autoCompleteWidget:function(){},barcodeWidget:function(){},offlineFileWidget:function(){if(!this.repeat){var a="Awaiting user permission to store local data (files)",b="info",c=!1,d=this.$group.find('input[type="file"]');0!==d.length&&(("undefined"==typeof fileManager?(b="warning",a="File uploads not supported."):fileManager.isSupported()?c=!0:(b="warning",a="File uploads not supported by your browser"),d.prop("disabled",!0).addClass("ignore").after('<div class="file-feedback text-'+b+'">'+a+"</div>"),
c)?(d.each(function(){var a=$(this),b=a.attr("data-loaded-file-name");b&&a.after('<div class="file-loaded text-warning">This form was loaded with "'+b+'". To preserve this file, do not change this input.</div>')}).parent().addClass("with-media clearfix"),fileManager.init(f.getInstanceID(),{success:function(){console.log("Whoheee, we have permission to use the file system");d.on("change.passthrough",function(a){var b,c,d,e=$(this);console.debug("namespace: "+a.namespace);if(a.namespace==="passthrough"){e.trigger("change.file");
return false}a=e.attr("data-previous-file-name");b=e[0].files[0];d=(c=e.attr("accept"))&&c==="image/*"?$("<img />"):c==="audio/*"?$('<audio controls="controls"/>'):c==="video/*"?$('<video controls="controls"/>'):$("<span>No preview (unknown mediatype)</span>");d.addClass("file-preview");a&&(!b||a!==b.name)&&fileManager.deleteFile(a);e.siblings(".file-feedback, .file-preview, .file-loaded").remove();console.debug("file: ",b);if(b&&b.size>0&&b.size<=connection.maxSubmissionSize()){console.debug("going to save it in filesystem");
fileManager.saveFile(b,{success:function(a){d.attr("src",a);e.trigger("change.passthrough").after(d)},error:function(a){console.error("error: ",a);e.val("");e.after('<div class="file-feedback text-error">Failed to save file</span>')}});return false}b.size>connection.maxSubmissionSize()&&e.after('<div class="file-feedback text-error">File too large (max '+Math.round(connection.maxSubmissionSize()*100/1048576)/100+" Mb)</div>");return true}).removeClass("ignore").prop("disabled",false).siblings(".file-feedback").remove();
d.after('<div class="text-info">File inputs are experimental. Use only for testing.')},error:function(){d.siblings(".file-feedback").remove();d.after('<div class="file-feedback text-warning">No permission given to store local data (or an error occurred).</div>')}})):d.hide())}},mediaLabelWidget:function(){this.repeat||$("fieldset:not(.jr-appearance-compact, .jr-appearance-quickcompact)>label, fieldset:not(.jr-appearance-compact, .jr-appearance-quickcompact)>legend").children("img,video,audio").parent().addClass("with-media clearfix")}};
e.prototype.preloads={init:function(a){var b,c,d,e,g,i,l,j,k=this;h.find("#jr-preload-items input").each(function(){l=a.input.getProps($(this));b=$(this).attr("data-preload").toLowerCase();c=$(this).attr("data-preload-params").toLowerCase();"undefined"!==typeof k[b]?(i=f.node(l.path,l.index),e=i.getVal()[0],g=k[b]({param:c,curVal:e,dataNode:i}),i.setVal(g,null,l.xmlType)):console.error('Preload "'+b+'"" not supported. May or may not be a big deal.')});f.node("*>meta>*").get().each(function(){b=null;
d=$(this).prop("nodeName");i=f.node("*>meta>"+d);e=i.getVal()[0];if(0===h.find('#jr-preload-items input[name$="/meta/'+d+'"][data-preload]').length)switch(d){case "instanceID":b="instance";j="string";c="";break;case "timeStart":b="timestamp";j="datetime";c="start";break;case "timeEnd":b="timestamp",j="datetime",c="end"}b&&i.setVal(k[b]({param:c,curVal:e,dataNode:i}),null,j)})},timestamp:function(a){var b;return"start"==a.param?0<a.curVal.length?a.curVal:f.evaluate("now()","string"):"end"==a.param?
(h.on("beforesave",function(){b=f.evaluate("now()","string");a.dataNode.setVal(b,null,"datetime")}),f.evaluate("now()","string")):"error - unknown timestamp parameter"},date:function(a){var b,c;return 0===a.curVal.length?(b=new Date(f.evaluate("today()","string")),a=b.getFullYear().toString().pad(4),c=(b.getMonth()+1).toString().pad(2),b=b.getDate().toString().pad(2),a+"-"+c+"-"+b):a.curVal},property:function(a){return 0===a.curVal.length?"no device properties in enketo":a.curVal},context:function(a){return 0===
a.curVal.length?"application"==a.param?"enketo":a.param+" not supported in enketo":a.curVal},patient:function(a){return 0===a.curVal.length?"patient preload not supported in enketo":a.curVal},user:function(a){return 0===a.curVal.length?"user preload item not supported in enketo yet":a.curVal},uid:function(a){return 0===a.curVal.length?"no uid yet in enketo":a.curVal},browser:function(){},os:function(a){return 0===a.curVal.length?"not known":a.curVal},instance:function(a){return 0<a.curVal.length?
a.curVal:f.evaluate("concat('uuid:', uuid())","string")}};e.prototype.repeat={init:function(a){var b,c,d,e,g,i,l,j,k,n=this;this.formO=a;h.find("fieldset.jr-repeat").prepend('<span class="repeat-number"></span>');h.find("fieldset.jr-repeat:not([data-repeat-fixed])").append('<button type="button" class="btn repeat"><i class="icon-plus"></i></button><button type="button" disabled class="btn remove"><i class="icon-minus"></i></button>');h.on("click","button.repeat:enabled",function(){n.clone($(this).parent("fieldset.jr-repeat"));
return!1});h.on("click","button.remove:enabled",function(){n.remove($(this).parent("fieldset.jr-repeat.clone"));return!1});i=function(a){l++;d=a.attr("data-repeat-count")||"";c=0<d.length?parseInt(f.node(d).getVal()[0],10):0;k=h.find('.jr-repeat[name="'+a.attr("name")+'"]').index(a);j=f.node(a.attr("name"),k).get();e=j.siblings(j.prop("nodeName")+":not([template])").addBack().length;g=c>e?c:e;for(b=1;b<g;b++)n.clone(a.siblings().addBack().last(),!1);a.siblings(".jr-repeat").addBack().find(".jr-repeat").filter(function(){return $(this).parents(".jr-repeat").length===
l}).each(function(){i($(this))})};h.find(".jr-repeat").filter(function(){return 0===$(this).parents(".jr-repeat").length}).each(function(){l=0;i($(this))})},clone:function(a){var b,c,d,e,g,i=this;if(1!==a.length)return console.error("Nothing to clone"),!1;b=a.parent("fieldset.jr-group").children("fieldset.jr-repeat:not(.clone)").eq(0);c=b.clone(!1);c.addClass("clone").find(".clone, .widget").remove();c.find(".invalid-required, .invalid-constraint").find("input, select, textarea").each(function(){i.formO.setValid($(this))});
c.insertAfter(a).parent(".jr-group").numberRepeats();c.clearInputs("");i.formO.widgets.init(c);a=h.find('fieldset.jr-repeat[name="'+a.attr("name")+'"]').index(a);d=[];c.find('input[type="radio"]').each(function(){-1===$.inArray($(this).attr("data-name"),d)&&d.push($(this).attr("data-name"))});console.debug("different radioNames in clone: "+d.join());for(e=0;e<d.length;e++)g=(new Date).getTime().toString()+"_"+Math.floor(1E4*Math.random()+1),c.find('input[type="radio"][data-name="'+d[e]+'"]').attr("name",
g);this.toggleButtons(b.parent());b=b.attr("name");console.log("index of form node to clone: "+a);0<b.length&&0<=a&&f.cloneTemplate(b,a);h.trigger("changerepeat");return!0},remove:function(a){var b=this,c=a.attr("name"),d=h.find('fieldset.jr-repeat[name="'+c+'"]').index(a),e=a.parent("fieldset.jr-group");a.hide(600,function(){a.remove();e.numberRepeats();b.toggleButtons(e);h.trigger("changerepeat");f.node(c,d).remove()})},toggleButtons:function(a){console.debug("toggling repeat buttons");a="undefined"==
typeof a||0===a.length||!a?a=h:a;a.find("button.repeat, button.remove").prop("disabled",!0);a.find("fieldset.jr-repeat:last-child > button.repeat").prop("disabled",!1);a.find("button.remove:not(:eq(0))").prop("disabled",!1)}};e.prototype.setEventHandlers=function(){var a=this;$("form.jr").attr("onsubmit","return false;");h.on("change.file validate","input:not(.ignore), select:not(.ignore), textarea:not(.ignore)",function(b){var c,d=a.input.getProps($(this));b.stopImmediatePropagation();0<d.val.length&&
("file"===d.inputType&&$(this)[0].files[0]&&0<$(this)[0].files[0].size)&&(d.val=$(this)[0].files[0].name,$(this).attr("data-previous-file-name",d.val));c="validate"===b.type?d.enabled&&"hidden"!==d.inputType?f.node(d.path,d.ind).validate(d.constraint,d.xmlType):!0:f.node(d.path,d.ind).setVal(d.val,d.constraint,d.xmlType);!1===(d.enabled&&"hidden"!==d.inputType&&d.required&&1>d.val.length?!1:!0)?(a.setValid($(this),"constraint"),"validate"===b.type&&a.setInvalid($(this),"required")):(a.setValid($(this),
"required"),"undefined"!==typeof c&&!1===c?a.setInvalid($(this),"constraint"):null!==c&&a.setValid($(this),"constraint"))});h.on("focus blur","[required]",function(b){var c=a.input.getProps($(this)),d=0<$(this).parents(".invalid-required, .invalid-constraint").length,e=$(this).next(".required-subtle"),f=$('<span class="required-subtle focus" style="color: transparent;">Required</span>');console.debug("event: ",b);"focusin"===b.type?0===e.length?(e=$(f),e.insertAfter(this),d||e.show(function(){$(this).removeAttr("style")})):
d||e.addClass("focus"):"focusout"===b.type&&(0<c.val.length?e.remove():(e.removeClass("focus"),d||e.removeAttr("style")))});h.on("dataupdate",function(b,c){a.calcUpdate(c);a.branch.update(c);a.outputUpdate(c);a.itemsetUpdate(c)});h.on("change changerepeat",function(){a.editStatus.set(!0)});h.on("changerepeat",function(){a.setAllVals()});h.on("changelanguage",function(){a.outputUpdate()})};e.prototype.setValid=function(a,b){this.input.getWrapNodes(a).removeClass(b?"invalid-"+b:"invalid-constraint invalid-required")};
e.prototype.setInvalid=function(a,b){b=b||"constraint";this.input.getWrapNodes(a).addClass("invalid-"+b).find(".required-subtle").attr("style","color: transparent;")};e.prototype.generateName=function(a){for(var b=[a.prop("nodeName")],a=a.parent();1==a.length&&"instance"!==a.prop("nodeName")&&"#document"!==a.prop("nodeName");)b.push(a.prop("nodeName")),a=a.parent();return"/"+b.reverse().join("/")};e.prototype.validateAll=function(){var a=this;h.find("fieldset:disabled input, fieldset:disabled select, fieldset:disabled textarea, input:disabled, select:disabled, textarea:disabled").each(function(){a.setValid($(this))});
h.find("input, select, textarea").not(".ignore").trigger("validate");return this.isValid()};e.prototype.isValid=function(){return 0<h.find(".invalid-required, .invalid-constraint").length?!1:!0};e.prototype.addPageBreaks=function(){}}
Date.prototype.toISOLocalString=function(){var a,c,b,d;if("Invalid Date"==this.toString())return this.toString();a=this.getTimezoneOffset();c=0>a?"+":"-";b=Math.abs(Math.floor(a/60));b=10>b?"0"+b:b;d=10>a%60?"0"+a%60:a%60;return(new Date(this.getTime()-6E4*a)).toISOString().replace("Z",c+b+":"+d)};
(function(a){a.fn.numberRepeats=function(){return this.each(function(){a(this).find("fieldset.jr-repeat").each(function(){var c,b,d;0===a(this).prev("fieldset.jr-repeat").length&&(c=a(this).siblings("fieldset.jr-repeat"),b=c.length+1,1<b?(a(this).find("span.repeat-number").text("1"),d=2,c.each(function(){a(this).find("span.repeat-number").text(d);d++})):a(this).find("span.repeat-number").empty())})})};a.fn.clearInputs=function(c){c=c||"edit";return this.each(function(){a(this).find("input, select, textarea").each(function(){var b=
a(this).attr("type");"SELECT"===a(this).prop("nodeName").toUpperCase()&&(b="select");"TEXTAREA"===a(this).prop("nodeName").toUpperCase()&&(b="textarea");switch(b){case "date":case "datetime":case "time":case "number":case "search":case "color":case "range":case "url":case "email":case "password":case "text":case "file":case "hidden":case "textarea":""!==a(this).val()&&a(this).val("").trigger(c);break;case "radio":case "checkbox":a(this).prop("checked")&&(a(this).prop("checked",!1),a(this).trigger(c));
break;case "select":0<=a(this)[0].selectedIndex&&(a(this)[0].selectedIndex=-1,a(this).trigger(c));break;default:console.error("Unrecognized input type found when trying to reset: "+b),console.error(a(this))}})})};a.fn.xfind=function(a){var b,d,a=a.replace(/\/\//g," "),a=a.replace(/^\//,""),a=a.replace(/\/\.$/,""),a=a.replace(/\//g,">"),a=a.replace(/\[([^@].*?)\]/g,function(a,b){return":has("+b+")"});if(0<=a.indexOf(">..")){a=a.split(/>\.\.>?/g);b=jQuery(a[0],this);for(d=1;d<a.length;d++)b=b.parent(a[d]);
return b.get()}a=a.replace(/\./gi,"\\.");return this.find(a)}})(jQuery);function FileManager(){var a,c,b,d,e,f,g,i,h,j=null,p=null;this.getCurrentQuota=function(){return j};this.getCurrentQuotaUsed=function(){return p};this.getFS=function(){return a};this.init=function(f,g){if(this.isSupported()&&f&&0<f.length){var j=this;i=f;h="/"+f+"/";e();c(104857600,{success:function(c){b(c,{success:function(b){a=b;j.createDir(i,g)},error:function(a){g.error(a);d(a)}})},error:d});$(document).on("submissionsuccess",function(a,b,c){j.deleteDir(c)});return!0}return!1};this.isSupported=
function(){window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;window.resolveLocalFileSystemURL=window.resolveLocalFileSystemURL||window.webkitResolveLocalFileSystemURL;window.storageInfo=window.storageInfo||window.webkitStorageInfo;return"undefined"!==typeof window.requestFileSystem&&"undefined"!==typeof window.resolveLocalFileSystemURL&&"undefined"!==typeof window.storageInfo};c=function(a,b){console.log("requesting persistent filesystem quota");$(document).trigger("quotarequest",
a);window.storageInfo.requestQuota(window.storageInfo.PERSISTENT,a,b.success,b.error)};b=function(a,b){console.log("requesting file system");console.log("quota for persistent storage granted in MegaBytes: "+a/1048576);0<a?(j=a,window.requestFileSystem(window.storageInfo.PERSISTENT,a,b.success,b.error)):(console.error("User did not approve storage of local data using the File API"),b.error())};d=function(a){var b="";if("undefined"!==typeof a)switch(a.code){case window.FileError.QUOTA_EXCEEDED_ERR:b=
"QUOTA_EXCEEDED_ERR";break;case window.FileError.NOT_FOUND_ERR:b="NOT_FOUND_ERR";break;case window.FileError.SECURITY_ERR:b="SECURITY_ERR";break;case window.FileError.INVALID_MODIFICATION_ERR:b="INVALID_MODIFICATION_ERR";break;case window.FileError.INVALID_STATE_ERR:b="INVALID_STATE_ERR";break;default:b="Unknown Error"}console.log("Error occurred: "+b);"undefined"!==typeof console.trace&&console.trace()};e=function(){"undefined"!==typeof window.storageInfo.queryUsageAndQuota?window.storageInfo.queryUsageAndQuota(window.storageInfo.PERSISTENT,
function(a){p=a},d):console.error("browser does not support queryUsageAndQuota")};this.saveFile=function(b,d){var f=this;a.root.getFile(h+b.name,{create:!0,exclusive:!1},function(a){a.createWriter(function(g){g.write(b);g.onwriteend=function(b){b.total===b.loaded&&(e(),console.log("complete file stored, with persistent url:"+a.toURL()),d.success(a.toURL()))};g.onerror=function(a){var e=a.target.error;e instanceof FileError&&e.code===window.FileError.QUOTA_EXCEEDED_ERR?(a=104857600>5*a.total?j+104857600:
j+5*a.total,console.log("Required storage exceeding quota, going to request more, in bytes: "+a),c(a,{success:function(a){console.log("request for additional quota approved! (quota: "+a+" bytes)");j=a;f.saveFile(b,d)},error:d.error})):d.error(a)}},d.error)},d.error)};this.retrieveFiles=function(a,b,c){var d=a?"/"+a+"/":h,e=function(a){g(a,{success:function(a){console.debug("retrieved file! ",a);var d;$.each(b,function(b,c){c.fileName===a.name&&(d=b)});console.debug("index:"+d);b[d].file=a;a.name===
b[b.length-1].fileName&&(console.log("files to return with success handler: ",b),c.success(b))},error:c.error})},f=c.error;0===b.length&&(console.log("files length is 0, calling success handler with empty array"),c.success([]));for(a=0;a<b.length;a++)this.retrieveFileEntry(d+b[a].fileName,{success:e,error:f})};this.retrieveFileEntry=function(b,c){console.debug("retrieving fileEntry for: "+b);a.root.getFile(b,{},function(a){console.log("fileEntry retrieved: ",a);console.log("persistent URL: ",a.toURL());
c.success(a)},function(a){console.error("file not found",a);c.error(a)})};g=function(a,b){a.file(b.success,b.error)};this.deleteFile=function(b,c){console.log("deleting file: "+b);c=c||{success:function(){},error:function(){}};a.root.getFile(h+b,{create:!1},function(a){a.remove(function(){e();console.log(b+" removed from file system");c.success()})},function(a){d(a);c.error()})};this.createDir=function(b,d){var f=this,d=d||{success:function(){},error:function(){}};a.root.getDirectory(b,{create:!0},
function(a){e();console.log("Directory: "+b+" created (or found)",a);d.success()},function(a){var e=a.target.error;e instanceof FileError&&e.code===window.FileError.QUOTA_EXCEEDED_ERR?(console.log("Required storage exceeding quota, going to request more."),a=104857600>5*a.total?j+104857600:j+5*a.total,c(a,{success:function(a){j=a;f.createDir(b,d)},error:d.error})):d.error(a)})};this.deleteDir=function(b,c){c=c||{success:function(){},error:function(){}};console.log("going to delete directory: "+b);
a.root.getDirectory(b,{},function(a){a.removeRecursively(function(){e();c.success()},function(a){d(a);c.error()})},d)};this.deleteAll=function(a){f({entryFound:function(a){a.isDirectory?a.removeRecursively(function(){e();console.log("Directory: "+a.name+" deleted")},d):a.remove(function(){e();console.log("File: "+a.name+" deleted")},d)},complete:a||function(){}})};this.listAll=function(a){var a=a||function(){},b=[];f({entryFound:function(a){a.isDirectory?b.push("folder: "+a.name):b.push("file: "+
a.name)},complete:function(){console.log("entries: ",b);a()}})};f=function(b){var c,e=a.root.createReader(),f=function(){e.readEntries(function(a){if(a.length){for(var d=0;d<a.length;d++)c=a[d],b.entryFound(c);f()}else b.complete()},d)};f()}};/*
 Copyright 2012 Martijn van de Rijdt & Modilabs

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
(function(a){var c=function(b,c,e){e&&(e.stopPropagation(),e.preventDefault());this.$element=a(b);this.$newElement=null;this.selectClass=c.btnStyle||"";this.noneSelectedText=c.noneSelectedText||"none selected";this.lengthmax=c.maxlength||20;this.multiple="undefined"!==typeof this.$element.attr("multiple")&&!1!==this.$element.attr("multiple");this.init()};c.prototype={constructor:c,init:function(){var a=this.getTemplate();this.$element.css("display","none");a=this.createLi(a);this.$element.after(a);
this.$newElement=this.$element.next(".bootstrap-select");this.$newElement.find("> a").addClass(this.selectClass);this.clickListener()},getTemplate:function(){return"<div class='btn-group bootstrap-select widget'><a class='btn dropdown-toggle clearfix' data-toggle='dropdown' href='#''><span class='filter-option pull-left'>__SELECTED_OPTIONS</span><span class='caret pull-right'></span></a><ul class='dropdown-menu' role='menu'>__ADD_LI</ul></div>"},createLi:function(b){var c=[],e="",f=this.multiple?
"type='checkbox'":"type='radio' style='display: none;' name='"+1E5*Math.random()+"'",g,i;this.$element.find("option").each(function(){c.push({label:a(this).text(),selected:a(this).is(":selected"),value:a(this).attr("value")})});if(0<c.length)for(var b=b.replace("__SELECTED_OPTIONS",this.createSelectedStr()),h=0;h<c.length;h++)c[h].value&&(g=c[h].selected?" checked='checked'":"",i=c[h].selected&&!this.multiple?"class='active'":"",e+="<li "+i+"><a tabindex='-1' href='#'><label class='checkbox inline'><input class='ignore' "+
f+g+"value='"+c[h].value+"' />"+c[h].label+"</label></a></li>");return b=b.replace("__ADD_LI",e)},createSelectedStr:function(b){var c=[],b=b||this.$element;b.find("option:selected").each(function(){0<a(this).attr("value").length&&c.push(a(this).text())});if(0===c.length)return this.noneSelectedText;b=c.join(", ");return b.length>this.lengthmax?c.length+" selected":b},clickListener:function(){var b=this;this.$newElement.find("li").on("click",function(c){c.preventDefault();var c=a(this),e=c.find("input"),
f=c.parents(".bootstrap-select"),g=f.prev("select"),i=g.find('option[value="'+e.val()+'"]'),h=i.is(":selected");b.multiple||(f.find("li").removeClass("active"),i.siblings("option").prop("selected",!1),f.find("input").prop("checked",!1));h?(c.removeClass("active"),e.prop("checked",!1),i.prop("selected",!1)):(b.multiple||c.addClass("active"),e.prop("checked",!0),i.prop("selected",!0));f.find(".filter-option").html(b.createSelectedStr(g));g.trigger("change")})},focusListener:function(){var a=this;a.$newElement.find(".dropdown-toggle").hover(function(){console.debug("focus...");
a.$element.trigger("focus");return!0},function(){console.debug("blur...");a.$element.trigger("blur");return!0})},update:function(){this.$newElement.remove();this.init()}};a.fn.selectpicker=function(b,d){return this.each(function(){var e=a(this),f=e.data("selectpicker"),g="object"==typeof b&&b;f||e.data("selectpicker",f=new c(this,g,d));if("string"==typeof b)f[b]()})};a.fn.selectpicker.Constructor=c})(window.jQuery);
(function(a){var c=function(b,c){this.$inputOrigin=a(b);this.$form=this.$inputOrigin.closest("form");this.$widget=a('<div class="geopoint widget"><div class="search-bar no-search-input no-map"></div><div class="geo-inputs"><label class="geo">latitude (x.y &deg;)<input class="ignore" name="lat" type="number" step="0.0001" /></label><label class="geo">longitude (x.y &deg;)<input class="ignore" name="long" type="number" step="0.0001" /></label><label class="geo"><input class="ignore" name="alt" type="number" step="0.1" />altitude (m)</label><label class="geo"><input class="ignore" name="acc" type="number" step="0.1" />accuracy (m)</label></div></div>');
navigator.geolocation&&(this.$widget.find(".search-bar").append('<button name="geodetect" type="button" class="btn" title="detect current location" data-placement="top"><i class="icon-crosshairs"></i></button>'),this.$detect=this.$widget.find('button[name="geodetect"]'));!0!==c.touch&&(this.$widget.find(".search-bar").removeClass("no-search-input").append('<div class="input-append"><input class="geo ignore" name="search" type="text" placeholder="search for place or address" disabled="disabled"/><button type="button" class="btn add-on"><i class="icon-search"></i></div>'),
this.$search=this.$widget.find('[name="search"]'));if(!0!==c.touch||!0===c.touch&&0<this.$inputOrigin.parents(".jr-appearance-maps").length)this.$widget.find(".search-bar").removeClass("no-map").after('<div class="map-canvas-wrapper"><div class="map-canvas"></div></div>'),this.$map=this.$widget.find(".map-canvas");this.$lat=this.$widget.find('[name="lat"]');this.$lng=this.$widget.find('[name="long"]');this.$alt=this.$widget.find('[name="alt"]');this.$acc=this.$widget.find('[name="acc"]');this.$inputOrigin.hide().after(this.$widget);
this.updateMapFn="updateDynamicMap";this.touch=c.touch||!1;this.init()};c.prototype={constructor:c,init:function(){var b=this,c=this.$inputOrigin.val().split(" ");this.$inputOrigin.parent().addClass("clearfix");this.$widget.find('input:not([name="search"])').on("change change.bymap change.bysearch",function(a){var c=""!==b.$lat.val()?b.$lat.val():0,d=""!==b.$lng.val()?b.$lng.val():0,i=""!==b.$alt.val()?b.$alt.val():0,h=b.$acc.val(),i=0===c&&0===d?"":c+" "+d+" "+i+" "+h;a.stopImmediatePropagation();
b.$inputOrigin.val(i).trigger("change");"bymap"!==a.namespace&&"bysearch"!==a.namespace&&b.updateMap(c,d);"bysearch"!==a.namespace&&this.$search&&b.$search.val("")});this.$widget.on("focus blur","input",function(a){b.$inputOrigin.trigger(a.type)});c[3]&&this.$acc.val(c[3]);c[2]&&this.$alt.val(c[2]);c[1]&&this.$lng.val(c[1]);0<c[0].length&&this.$lat.val(c[0]).trigger("change");this.$detect&&this.enableDetection();if(this.touch)this.$map&&(this.updateMapFn="updateStaticMap",this.updateMap(0,0,1),a(window).on("resize",
function(){var c=a(window).data("resizecount")||0;c++;a(window).data("resizecount",c);window.setTimeout(function(){c==a(window).data("resizecount")&&(a(window).data("resizecount",0),console.debug("resizing stopped"),b.updateMap())},500)}));else if(b.dynamicMapAvailable())b.updateMap(0,0,1),b.$search&&b.enableSearch();else this.$form.on("googlemapsscriptloaded",function(){b.dynamicMapAvailable()&&(b.updateMap(0,0,1),b.$search&&b.enableSearch())})},enableDetection:function(){var a=this;this.$detect.click(function(c){c.preventDefault();
navigator.geolocation.getCurrentPosition(function(c){a.updateMap(c.coords.latitude,c.coords.longitude);a.updateInputs(c.coords.latitude,c.coords.longitude,c.coords.altitude,c.coords.accuracy)});return!1})},enableSearch:function(){var b=new google.maps.Geocoder,c=this;this.$search.prop("disabled",!1);this.$search.on("change",function(e){e.stopImmediatePropagation();var f=a(this).val();"undefined"!==typeof b&&b.geocode({address:f,bounds:c.map.getBounds()},function(a,b){if(b==google.maps.GeocoderStatus.OK){c.$search.attr("placeholder",
"search");var e=a[0].geometry.location;c.updateMap(e.lat(),e.lng());c.updateInputs(e.lat(),e.lng(),null,null,"change.bysearch")}else c.$search.val(""),c.$search.attr("placeholder",f+" not found, try something else.")});return!1})},dynamicMapAvailable:function(){return this.$map&&"undefined"!==typeof google&&"undefined"!==typeof google.maps},updateMap:function(a,c,e){if(this.$map)return a=a||Number(this.$lat.val()),c=c||Number(this.$lng.val()),e=e||15,0===a&&0===c&&(e=1),this[this.updateMapFn](a,c,
e)},updateStaticMap:function(a,c,e){var f=this.$map.width(),g=this.$map.height(),a="center="+a+","+c+"&size="+f+"x"+g+"&zoom="+e+"&sensor=false&key="+(settings.mapsStaticAPIKey||"");this.$map.empty().append('<img src="http://maps.googleapis.com/maps/api/staticmap?'+a+'"/>')},updateDynamicMap:function(a,c,e){var f=this;this.dynamicMapAvailable()&&"undefined"!==typeof google.maps.LatLng&&(a={zoom:e,center:new google.maps.LatLng(a,c),mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:!1},this.map=
new google.maps.Map(this.$map[0],a),this.placeMarker(),google.maps.event.addListener(this.map,"click",function(a){f.updateInputs(a.latLng.lat(),a.latLng.lng(),"","","change.bymap");f.placeMarker(a.latLng)}))},placeMarker:function(a){var c,a=a||this.map.getCenter();"undefined"!==typeof this.marker&&this.marker.setMap(null);this.marker=new google.maps.Marker({position:a,map:this.map,draggable:!0});c=this;this.touch||(google.maps.event.addListener(this.marker,"dragend",function(){c.updateInputs(c.marker.getPosition().lat(),
c.marker.getPosition().lng(),"","","change.bymap");c.centralizeWithDelay()}),this.centralizeWithDelay(5E3));this.centralizeWithDelay(0)},centralizeWithDelay:function(a){var c=this;window.setTimeout(function(){c.map.panTo(c.marker.getPosition())},a)},updateInputs:function(a,c,e,f,g){e=e||"";f=f||"";g=g||"change";this.$lat.val(Math.round(1E4*a)/1E4);this.$lng.val(Math.round(1E4*c)/1E4);this.$alt.val(Math.round(10*e)/10);this.$acc.val(Math.round(10*f)/10).trigger(g)},loadMapsScript:function(){}};a.fn.geopointWidget=
function(b){var d=!1;return this.each(function(){var e=a(this),f=a(this).data("geopointwidget"),g="object"==typeof b&&b;if(!d&&"undefined"!==typeof connection&&("undefined"==typeof google||"undefined"==typeof google.maps)&&!b.touch)d=!0,console.debug("loading maps script asynchronously"),connection.loadGoogleMaps(function(){a("form.jr").trigger("googlemapsscriptloaded")});f||e.data("geopointwidget",f=new c(this,g));if("string"==typeof b)f[b]()})};a.fn.geopointWidget.Constructor=c})(window.jQuery);
(function(a){var c=function(b,c,e){e&&(e.stopPropagation(),e.preventDefault());this.$fileInput=a(b);this.nameAttr=this.$fileInput.attr("name");this.$fileNameInput=null;this.init()};c.prototype={constructor:c,init:function(){this.$fileInput.addClass("ignore");this.$fileNameInput=a('<input type="hidden" />').attr("name",this.nameAttr).after(this.$fileInput);this.changeListener()},changeListener:function(){this.$fileInput.on("change",function(a){a.stopImmediatePropagation()})},getPersistentName:function(){}};
a.fn.offlineFilepicker=function(b,d){return this.each(function(){var e=a(this),f=e.data("offlinefilepicker"),g="object"==typeof b&&b;f||e.data("offlinefilepicker",f=new c(this,g,d));if("string"==typeof b)f[b]()})};a.fn.offlineFilepicker.Constructor=c})(window.jQuery);/*
 Copyright 2012 Martijn van de Rijdt

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
function StorageLocal(){function a(a){var b;for(b=0;b<c.length;b++)if(a===c[b])return!0;return!1}var c="__settings null __history Firebug undefined __bookmark __counter __current_server __loadLog".split(" "),b=window.localStorage;this.init=function(){var a=this;$(document).on("submissionsuccess",function(b,c){a.removeRecord(c);console.log("After submission event was detected, tried to remove record with key: "+c)})};this.isSupported=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(a){return!1}};
this.getForbiddenKeys=function(){return c};this.setRecord=function(c,e,f,g,i){if(!c||"string"!==typeof c||1>c.length)return console.error("no key or empty key provided for record: "+c),"require";c=c.trim();i="string"===typeof i?i.trim():null;g="undefined"!==typeof g&&!0===g?!0:!1;if("string"===typeof e.data&&a(c))return"forbidden";var h;if(h="string"===typeof e.data)if(h=i!==c)h=b.getItem(c)?!0:!1,h=h&&!0!==g;if(h||i===c&&!0!==g)return"existing";try{return"string"===typeof e.data&&(e.lastSaved=(new Date).getTime(),
b.setItem("__counter",JSON.stringify({counter:this.getCounterValue()}))),b.setItem(c,JSON.stringify(e)),console.debug("saved: "+c+", old key was: "+i),null!==i&&(""!==i&&i!==c)&&f&&(console.log("going to remove old record with key:"+i),this.removeRecord(i)),"success"}catch(j){if(22===j.code)return"full";console.log("error in store.setRecord:"+j.message,j);return"error"}};this.getRecord=function(a){var c;try{return c=JSON.parse(b.getItem(a))}catch(f){return console.error("error with loading data from store: "+
f.message),null}};this.removeRecord=function(a){try{return b.removeItem(a),$("form.jr").trigger("delete",JSON.stringify(this.getRecordList())),!0}catch(c){return console.log("error with removing data from store: "+c.message),!1}};this.getFormList=function(a){return"undefined"==typeof a?null:this.getRecord("__server_"+a)};this.getRecordList=function(){var a,b,c=[],g=this.getSurveyRecords(!1);for(a=0;a<g.length;a++)b=g[a],c.push({key:b.key,ready:b.ready,lastSaved:b.lastSaved});console.debug("formList returning "+
c.length+" items");c.sort(function(a,b){return b.lastSaved-a.lastSaved});return c};this.getSurveyRecords=function(c,e){var f,g,i=[],h={},c=c||!1,e=e||null;for(f=0;f<b.length;f++)if(g=b.key(f),h=this.getRecord(g),!a(g))try{h.key=g,g!==e&&(!c||"true"===h.ready||!0===h.ready)&&i.push(h)}catch(j){console.log("record found that was probably not in the correct JSON format (e.g. Firebug settings or corrupt record) (error: "+j.message+"), record was ignored")}return i};this.getSurveyDataArr=function(a,b){var c,
g,i=[];g=this.getSurveyRecords(a||!0,b);for(c=0;c<g.length;c++)i.push({name:g[c].key,data:g[c].data});return i};this.getSurveyDataOnlyArr=function(a){for(var b=this.getSurveyDataArr(a),c=[],a=0;a<b.length;a++)c.push(b[a].data);return 0<c.length?c:null};this.getCounterValue=function(){var a=this.getRecord("__counter");return((a&&"undefined"!==typeof a.counter&&isNumber(a.counter)?Number(a.counter):0)+1).toString().pad(4)}}function isNumber(a){return!isNaN(parseFloat(a))&&isFinite(a)};/*
 Copyright 2012 Martijn van de Rijdt

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
var store;$(document).ready(function(){void 0!==typeof StorageLocal&&(store=new StorageLocal,store.init())});function resetForm(a){console.debug("editstatus: "+form.getEditStatus());!a&&form.getEditStatus()?(a={posAction:function(){resetForm(!0)}},gui.confirm("There are unsaved changes, would you like to continue <strong>without</strong> saving those?",a)):(form.resetHTML(),form=new Form("form.jr:eq(0)",jrDataStr),form.init(),$("button#delete-form").button("disable"))}
function submitForm(){var a,c,b;$("form.jr").trigger("beforesave");form.isValid()?(a={data:form.getDataStr(!0,!0),ready:!0},c=form.getName()+" - "+store.getCounterValue(),b=store.setRecord(c,a,!1,!1),console.log("result of save: "+b),"success"===b?(gui.feedback("Record queued for submission.",3),resetForm(!0),$("form.jr").trigger("save",JSON.stringify(store.getRecordList())),prepareFormDataArray({name:c,data:a.data},{success:function(a){connection.uploadRecords(a,!0)},error:function(){gui.alert("Something went wrong while trying to prepare the record(s) for uploading.",
"Record Error")}})):gui.alert("Error trying to save data locally before submit")):gui.alert("Form contains errors <br/>(please see fields marked in red)")}
function submitEditedForm(){var a,c,b;$("form.jr").trigger("beforesave");form.isValid()?(c="undefined"!==typeof settings&&"undefined"!==typeof settings.returnURL&&settings.returnURL?!0:!1,gui.alert((c?"You will be automatically redirected after submission. ":"")+'<br /><progress style="text-align: center;"/>',"Submitting..."),a={name:"iframe_record",data:form.getDataStr(!0,!0)},b={error:function(){gui.alert("Please try submitting again.","Submission failed")},success:function(){c?(gui.alert("You will now be redirected back to formhub.",
"Submission successful!"),location.href=settings.returnURL):(gui.alert("Done!","Submission successful!"),resetForm(!0))},complete:function(){}},prepareFormDataArray(a,{success:function(a){connection.uploadRecords(a,!0,b)},error:function(){gui.alert("Something went wrong while trying to prepare the record(s) for uploading.","Record Error")}})):gui.alert("Form contains errors <br/>(please see fields marked in red)")}
function prepareFormDataArray(a,c){var b,d,e,f,g,i,h,j,p,l,m=[],q=[];b=form.Data(a.data);f=b.getStr(!0,!0);i=b.getInstanceID();h=b.$.find('[type="file"]').removeAttr("type");j=[];for(b=0;b<h.length;b++)j.push({nodeName:h[b].nodeName,fileName:h.eq(b).text()});console.debug("files to find in local filesystem for instanceID "+i+": ",j);"undefined"!==typeof fileManager&&0<j.length?fileManager.retrieveFiles(i,j,{success:function(b){for(d=0;d<b.length;d++)m.push(b[d].file.size);q=divideIntoBatches(m,connection.maxSubmissionSize());
console.debug("splitting record into "+q.length+" batches to reduce submission size ",q);for(d=0;d<q.length;d++){g=new FormData;g.append("xml_submission_data",f);l={name:a.name,instanceID:i,formData:g,batches:q.length,batchIndex:d};for(e=0;e<q[d].length;e++)p=q[d][e],console.log("adding file: "+b[p].nodeName),l.formData.append(b[p].nodeName,b[p].file);console.log("returning record with formdata : ",l);c.success(l)}},error:function(a){console.error("Error occured when trying to retrieve files from local filesystem",
a)}}):(g=new FormData,g.append("xml_submission_data",f),l={name:a.name,instanceID:i,formData:g,batches:1,batchIndex:0},c.success(l))}function exportData(a){a=store.getSurveyDataOnlyArr(a||!0);0===a.length?gui.feedback("No data to export."):(a=vkbeautify.xml("<exported>"+a.join("")+"</exported>"),a="data:application/octet-stream,"+encodeURIComponent(a),window.open(a,"exportedData"))}
function exportToFile(){var a,c,b,d,e,f=form.getName()+"_data_backup.xml";gui.confirm({msg:"Records are stored inside the browser until they are submitted (even if you turn off your computer or go offline). <br/><br/>As a backup, to save all queued records to a file, click export.",heading:"Export queued records"},{posButton:"Export",negButton:"Cancel",posAction:function(){a=store.getSurveyDataOnlyArr(!0);!a||0===a.length?gui.alert("No records in queue. The records may have been successfully submitted already."):
(e=settings.serverURL||"",c=vkbeautify.xml('<exported server="'+e+'">'+a.join("")+"</exported>"),b=new BlobBuilder,b.append(c),d=b.getBlob("application/octet-stream; charset=utf-8"),saveAs(d,f))}})}
GUI.prototype.setCustomEventHandlers=function(){var a=this;$("button#reset-form").click(function(){resetForm()});$("button#submit-form").click(function(){form.validateForm();submitForm();return!1});$("button#submit-edited-data").click(function(){form.validateForm();submitEditedForm();return!1});$(document).on("click","button#validate-form:not(.disabled)",function(){"undefined"!==typeof form&&(form.validateForm(),form.isValid()||gui.alert("Form contains errors <br/>(please see fields marked in red)"))});
$(".records").on("click",function(){exportToFile()});$("#form-controls button").toLargestWidth();$(document).on("save delete","form.jr",function(c,b){console.debug("save or delete event detected with new formlist: "+b);a.updateRecordList(JSON.parse(b))});$("#dialog-save").hide()};
GUI.prototype.updateRecordList=function(a,c){var b,d,e,f,g,i=0,h=0;console.debug("updating recordlist in GUI");c||(c=this.pages.get("records"));g=c.find("#records-saved ol");g.children().remove();a=a||[];if(0<a.length){for(e=0;e<a.length;e++)b=a[e].key,d=(new Date(a[e].lastSaved)).toDateString(),a[e].ready?(f="check",i++):(f="pencil",h++),d=$('<li><span class="ui-icon ui-icon-'+f+'"></span><span class="name"></span><span class="date"> ('+d+")</span></li>"),d.find(".name").text(b),g.append(d);$(".queue-length").text(a.length).parent().show()}else $('<li class="no-click">no locally saved records found</li>').appendTo(g),
$(".queue-length").text("0").parent().hide();c.find("#records-draft-qty").text(h);c.find("#records-final-qty").text(i)};/*
 Copyright 2012 Martijn van de Rijdt

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
var form,source,url,$tabs,$upload,_error,state,connection,fileManager,error_msg='There were errors. Please see the "report" tab for details.',templateShow=!1;
$(document).ready(function(){connection=new Connection;state=new State;state.init();_error=console.error;console.error=function(){addJsError(arguments[0]);gui.feedback(error_msg);return _error.apply(console,arguments)};state.source||($("#html5-form-source").hide(),$('li a[href="#html5-form-source"]').parent("li").remove());$('li a[href="#upload"]').tab("show");gui.setup();$('#upload-form [name="xml_file"]').change(function(){$("#upload-form").submit()});$("#upload-form").submit(function(){var a=$(this).find('[name="form_id"]').val(),
c=$(this).find('[name="server_url"]'),b=c.val(),d=$(this).find('[name="xml_file"]'),d=d.val()?d[0].files[0]:null,e=function(a,b,c){b!=="validationerror"?gui.feedback("Sorry, an error occured while communicating with the Enketo server. ("+c+")"):gui.alert(c)},f=function(){$("#upload progress").hide()};resetAll();$("#upload progress").show();if(a||d){d&&$("#form-list ul").empty();connection.getTransForm(b,a,d,null,{success:function(c){state.server=b?b:null;state.id=a?a:null;state.setUrl();processForm($(c))},
error:e,complete:f})}else{$("#form-list ul").empty();connection.getFormlist(b,{success:function(a){state.server=b;state.id=null;state.setUrl();processFormlist(a);c.val(b)},error:e,complete:f})}return false});$("#upload-form #input-switcher a").click(function(a){a.preventDefault();$("#upload-form label").hide().find('input[name="'+$(this).attr("id")+'"]').parents("label").show();$(this).siblings().removeClass("active");$(this).addClass("active")});$("#data-template-show input").change(function(){templateShow=
$(this).is(":checked")?true:false;updateData()});$(document).on("click","#form-list a",function(a){var c=$(this).attr("id").toString(),b=$(this).attr("data-server");a.preventDefault();$('#upload-form input[name="server_url"]').val(b);$('#upload-form input[name="form_id"]').val(c);$("#upload-form").submit()});$("#html5-form-source form").submit(function(){var a,c='<!DOCTYPE html><html><head><meta charset="utf-8" /><title></title></head><body>'+$(this).find('textarea[name="content"]').val()+"</body></html>";
$("#html5validationmessages div").html('<form style="text-align:center;"><progress></progress></form>');connection.validateHTML(c,{success:function(b){var c=$("<div></div>");c.append(b.replace(/<script[A-z =".]*><\/script>/gi,""));c.find("ol:not(.source) li>*:first-child").each(function(){a=$(this).parent("li").attr("class");$(this).addClass(a)});parseMsgList(c.find("p.success, ol:not(.source) li>*:first-child"),$("#html5validationmessages div"));$("#html5validationmessages div li.info").hide()},
error:function(){$("#html5validationmessages div").empty().append('<ol><li class="info"><span class="ui-icon ui-icon-info"></span>This validation is currently not functional</li></ol>')}});return false});$("#upload-form #input-switcher a#server_url").click();state.server?($('#upload-form input[name="server_url"]').val(state.server),$('#upload-form input[name="form_id"]').val(state.id),$("#upload-form").submit()):(console.log("no server in state"),$(".hurry").show(),gui.parseFormlist(null,$("#form-list"),
!0))});function State(){}
State.prototype.init=function(){var a,c=decodeURIComponent(decodeURI(helper.getQueryParam("server")));this.initialURL=location.href;this.server=c&&connection.isValidURL(c)?c:null;this.id=helper.getQueryParam("id")||null;this.source=helper.getQueryParam("source")||!1;this.debug=helper.getQueryParam("debug")||!1;this.everPushedState=!1;a=this;state.setUrl();$(window).on("popstate",function(){a.everPushedState&&location.href!==a.initialURL&&(window.location=location.href)});setTimeout(function(){a.everPushedState=
!0},1E3)};
State.prototype.setUrl=function(){var a={server:this.server,id:this.id,source:this.source,debug:this.debug},c="",b="formtester",c=null!==this.server&&connection.isValidURL(this.server)?c+"server="+encodeURIComponent(this.server):c,c=null!==this.id?c+"&id="+encodeURIComponent(this.id):c,c="true"==this.source||!0===this.source?c+"&source="+encodeURIComponent(this.source):c,c="true"==this.debug||!0===this.debug?c+"&debug="+encodeURIComponent(this.debug):c,c="&"==c.substring(0,1)?c.substring(1):c,b=0<
c.length?b+"?"+c:b;(location.href!==location.protocol+"//"+location.hostname+"/"+b||this.everPushedState)&&history.pushState(a,"Enketo Form Tester",b)};State.prototype.reset=function(){console.debug("resetting state");this.id=this.server=null;this.setUrl()};
function resetAll(){$("#upload-form")[0].reset();$('#upload-form input[type="hidden"]').val("");$("#upload progress").hide();$("#form-languages").remove();$("#survey-form form, #xsltmessages div, #html5validationmessages div, #jrvalidationmessages div, #xmlerrors div, #xslerrors div, #html5-form-source textarea, #data textarea").empty();form=null;$("#validate-form").addClass("disabled");$('.nav li a[href="#upload"]').tab("show")}
function processForm(a){var c=(new XMLSerializer).serializeToString(a.find(":first>form")[0]),b=(new XMLSerializer).serializeToString(a.find(":first>model")[0]),d=a.find("xsltmessages message"),e=a.find("jrvalidationmessages message"),f=a.find("xmlerrors message"),a=a.find("xslformerrors message, xsldataerrors message");$("#upload progress").hide();0<c.length?($("#html5-form-source textarea").empty().text(vkbeautify.xml(c)),$("#html5-form-source form").submit(),$("#survey-form form").replaceWith(c),
form=new Form("form.jr:eq(0)",b),form.init(),$('.nav a[href="#survey-form"]').tab("show"),$(document).on("change dataupdate","form.jr",updateData),$("#validate-form").removeClass("disabled")):($("#survey-form div").empty(),$('.nav li a[href="#report"]').tab("show"));form&&0<form.getDataStr().length?updateData():$("#data div").text("An error occurred whilst trying to extract the data.");form&&(0<form.getDataStr().length&&0===d.length)&&(d=$('<message class="success">Nothing reported back. A good sign if there are no other errors!</message>'));
parseMsgList(d,$("#xsltmessages div"));0===e.length&&(e=$('<message class="info">Something went wrong</message>'));parseMsgList(e,$("#jrvalidationmessages div"));0===f.length&&(f=$('<message class="success">Valid XML document!</message>'));parseMsgList(f,$("#xmlerrors div"));0<a.length&&a.each(function(){console.error("XSLT stylesheet error: "+$(this).text())});form&&(0<form.getDataStr().length&&0<$("#report .level-2, #report .level-3").length)&&gui.feedback(error_msg)}
function processFormlist(a){$(".hurry").hide();gui.parseFormlist(a,$("#form-list"))}function updateData(){if(form){var a=form.getDataStr(templateShow);$("#data textarea").empty().text(vkbeautify.xml(a))}}
function parseMsgList(a,c){var b=$("<ul></ul>");a.each(function(){var a="",c=$(this).text(),f={"0":"info","info warning":"warning",1:"warning",2:"error",3:"error"},a=$(this).attr("level")?$(this).attr("level"):$(this).attr("class"),a='<li class="'+(f[a]?"text-"+f[a]:"muted")+'">'+c+"</li>";0===b.find("li").filter(function(){return $(this).text()==c}).length&&b.append(a)});c.empty().append(b)}
function addJsError(a){1!==$("#jserrors div ul").length&&$("#jserrors div").append("<ul></ul>");$("#jserrors div ul").append('<li class="text-error">'+a+"</li>")};/*
 Copyright 2012 Martijn van de Rijdt

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
function Connection(){var a=this;this.CONNECTION_URL="/checkforconnection.php";this.SUBMISSION_URL="/data/submission";this.GETSURVEYURL_URL="/launch/get_survey_url";this.uploadOngoingBatchIndex=this.uploadOngoingID=this.currentOnlineStatus=null;this.uploadResult={win:[],fail:[]};this.uploadQueue=[];this.oRosaHelper=new this.ORosaHelper(this);this.init=function(){this.checkOnlineStatus();a=this;window.setInterval(function(){a.checkOnlineStatus()},15E3);$(window).on("offline online",function(){console.log("window network event detected");
a.setOnlineStatus(a.getOnlineStatus())});$(window).trigger("online")}}Connection.prototype.checkOnlineStatus=function(){var a,c=this;navigator.onLine?this.uploadOngoingID||$.ajax({type:"GET",url:this.CONNECTION_URL,cache:!1,dataType:"json",timeout:3E3,complete:function(b){a="undefined"!==typeof b.responseText&&"connected"===b.responseText;c.setOnlineStatus(a)}}):this.setOnlineStatus(!1)};Connection.prototype.getOnlineStatus=function(){return this.currentOnlineStatus};
Connection.prototype.setOnlineStatus=function(a){a!==this.currentOnlineStatus&&(console.log("online status changed to: "+a+", triggering window.onlinestatuschange"),$(window).trigger("onlinestatuschange",a));this.currentOnlineStatus=a};
Connection.prototype.uploadRecords=function(a,c,b){var d,e,f,c=c||!1,b=b||null;if(!a.name||!a.instanceID||!a.formData||!a.batches||"undefined"==typeof a.batchIndex)return!1;d=$.grep(this.uploadQueue,function(b){return a.instanceID===b.instanceID&&a.batchIndex===b.batchIndex});e=$.grep(this.uploadResult.win,function(b){return a.instanceID===b.instanceID&&a.batchIndex===b.batchIndex});f=this.uploadOngoingID===a.instanceID&&this.uploadOngoingBatchIndex===a.batchIndex;0===d.length&&0===e.length&&!f?(a.forced=
c,this.uploadQueue.push(a),this.uploadOngoingID||(this.uploadResult={win:[],fail:[]},this.uploadBatchesResult={},this.uploadOne(b))):d.forced=c;return!0};
Connection.prototype.uploadOne=function(a){var c,b,d=this,a="undefined"===typeof a||!a?{complete:function(a){$(document).trigger("submissioncomplete");d.processOpenRosaResponse(a.status,{name:c.name,instanceID:c.instanceID,batches:c.batches,batchIndex:c.batchIndex,forced:c.forced});d.uploadOne()},error:function(a,b){"timeout"===b?console.debug("submission request timed out"):console.error("error during submission, textStatus:",b)},success:function(){}}:a;0<this.uploadQueue.length&&(c=this.uploadQueue.pop(),
!1===this.currentOnlineStatus?this.processOpenRosaResponse(0,c):(this.uploadOngoingID=c.instanceID,this.uploadOngoingBatchIndex=c.batchIndex,b=c.formData,b.append("Date",(new Date).toUTCString()),console.debug("prepared to send: ",b),this.setOnlineStatus(null),$(document).trigger("submissionstart"),$.ajax(this.SUBMISSION_URL,{type:"POST",data:b,cache:!1,contentType:!1,processData:!1,timeout:3E5,complete:function(b,c){d.uploadOngoingID=null;d.uploadOngoingBatchIndex=null;a.complete(b,c)},error:a.error,
success:a.success})))};
Connection.prototype.processOpenRosaResponse=function(a,c){var b,d,e,f="";e=[];b="Contact "+settings.supportEmail+" please.";var g="Sorry, the enketo or formhub server is down. Please try again later or contact "+settings.supportEmail+" please.";b={"0":{success:!1,msg:"undefined"!==typeof jrDataStrToEdit?"Uploading of data failed. Please try again.":"Uploading of data failed (maybe offline) and will be tried again later."},200:{success:!1,msg:"Data server did not accept data. "+b},201:{success:!0,
msg:""},202:{success:!0,msg:""},"2xx":{success:!1,msg:"Unknown error occurred when submitting data. "+b},400:{success:!1,msg:"Data server did not accept data. Contact the survey administrator please."},403:{success:!1,msg:"You are not allowed to post data to this data server. Contact the survey administrator please."},404:{success:!1,msg:"Submission service on data server not found or not properly configured."},"4xx":{success:!1,msg:"Unknown submission problem on data server."},413:{success:!1,msg:"Data is too large. Please contact "+
settings.supportEmail+"."},500:{success:!1,msg:g},503:{success:!1,msg:g},"5xx":{success:!1,msg:g}};console.debug("submission results with status: "+a+" for ",c);c.batchText=1<c.batches?" (batch #"+(c.batchIndex+1)+" out of "+c.batches+")":"";if("undefined"!==typeof b[a])if(c.msg=b[a].msg,!0===b[a].success){if(1<c.batches){"undefined"==typeof this.uploadBatchesResult[c.instanceID]&&(this.uploadBatchesResult[c.instanceID]=[]);this.uploadBatchesResult[c.instanceID].push(c.batchIndex);for(b=0;b<c.batches;b++)-1===
$.inArray(b,this.uploadBatchesResult[c.instanceID])&&(d=!0)}d?console.debug("not all batches for instanceID have been submitted, current queue:",this.uploadQueue):$(document).trigger("submissionsuccess",[c.name,c.instanceID]);this.uploadResult.win.push(c)}else!1===b[a].success&&this.uploadResult.fail.push(c);else 500<a?(console.error("Error during uploading, received unexpected statuscode: "+a),c.msg=b["5xx"].msg,this.uploadResult.fail.push(c)):400<a?(console.error("Error during uploading, received unexpected statuscode: "+
a),c.msg=b["4xx"].msg,this.uploadResult.fail.push(c)):200<a&&(console.error("Error during uploading, received unexpected statuscode: "+a),c.msg=b["2xx"].msg,this.uploadResult.fail.push(c));if(!(0<this.uploadQueue.length)){console.debug("online: "+this.currentOnlineStatus,this.uploadResult);if(0<this.uploadResult.win.length){for(b=0;b<this.uploadResult.win.length;b++)d=this.uploadResult.win[b].name,-1===$.inArray(d,e)&&(e.push(d),f="undefined"!==typeof this.uploadResult.win[b].msg?f+this.uploadResult.win[b].msg+
" ":"");d=1<e.length?" were":" was";e=e.join(", ");gui.feedback(e.substring(0,e.length)+d+" successfully uploaded. "+f);this.setOnlineStatus(!0)}if(0<this.uploadResult.fail.length){f="";if(!1!==this.currentOnlineStatus){for(b=0;b<this.uploadResult.fail.length;b++)this.uploadResult.fail[b].forced&&(f+=this.uploadResult.fail[b].name+this.uploadResult.fail[b].batchText+": "+this.uploadResult.fail[b].msg+"<br />");f&&gui.alert(f,"Failed data submission")}this.setOnlineStatus(!1)}}};
Connection.prototype.maxSubmissionSize=function(){var a,c=this;return"undefined"==typeof this.maxSize&&!this.maxSize?($.ajax("/data/max_size",{type:"GET",async:!1,timeout:5E3,success:function(b){a=parseInt(b,10)||5E6;a=104857600<a?104857600:a;c.maxSize=a},error:function(){a=5E6}}),a):this.maxSize};Connection.prototype.isValidURL=function(a){return/^(https?:\/\/)(([\da-z\.\-]+)\.([a-z\.]{2,6})|(([0-9]{1,3}\.){3}[0-9]{1,3}))([\/\w \.\-]*)*\/?[\/\w \.\-\=\&\?]*$/.test(a)};
Connection.prototype.getFormlist=function(a,c){c=this.getCallbacks(c);this.isValidURL(a)?$.ajax("/forms/get_list",{type:"GET",data:{server_url:a},cache:!1,contentType:"json",timeout:6E4,success:c.success,error:c.error,complete:c.complete}):c.error(null,"validationerror","not a valid URL")};
Connection.prototype.getSurveyURL=function(a,c,b){b=this.getCallbacks(b);!a||!this.isValidURL(a)?b.error(null,"validationerror","not a valid server URL"):!c||0===c.length?b.error(null,"validationerror","not a valid formId"):$.ajax({url:this.GETSURVEYURL_URL,type:"POST",data:{server_url:a,form_id:c},cache:!1,timeout:6E4,dataType:"json",success:b.success,error:b.error,complete:b.complete})};
Connection.prototype.getTransForm=function(a,c,b,d,e){var f=new FormData,e=this.getCallbacks(e),a=a||null,c=c||null,d=d||null,b=b||new Blob;0===b.size&&(!a||!c)&&!d?e.error(null,"validationerror","No form file or URLs provided"):0===b.size&&!this.isValidURL(a)&&!this.isValidURL(d)?e.error(null,"validationerror","Not a valid server or form url"):0===b.size&&!d&&(!c||0===c.length)?e.error(null,"validationerror","No form id provided"):(f.append("server_url",a),f.append("form_id",c),f.append("form_url",
d),f.append("xml_file",b),console.debug("form file: ",b),$.ajax("/transform/get_html_form",{type:"POST",cache:!1,contentType:!1,processData:!1,dataType:"xml",data:f,success:e.success,error:e.error,complete:e.complete}))};Connection.prototype.validateHTML=function(a,c){var b=new FormData,c=this.getCallbacks(c);b.append("level","error");b.append("content",a);$.ajax("/html5validate/",{type:"POST",data:b,contentType:!1,processData:!1,success:c.success,error:c.error,complete:c.complete})};
Connection.prototype.ORosaHelper=function(a){this.fragToServerURL=function(c,b){var d;d="";if(!b)return console.log("nothing to do"),null;console.debug("frag: "+b);if(a.isValidURL(b))return b;switch(c){case "http":case "https":d=/^http(|s):\/\//.test(b)?"":c+"://";d+=b;break;case "formhub_uni":case "formhub":d="https://formhub.org/"+b;break;case "appspot":d="https://"+b+".appspot.com"}if(!a.isValidURL(d))return console.error("not a valid url: "+d),null;console.log("server_url: "+d);return d}};
Connection.prototype.getNumberFormsLaunched=function(a){a=this.getCallbacks(a);$.ajax({url:"/front/get_number_launched_everywhere",dataType:"json",success:a.success,error:a.error,complete:a.complete})};Connection.prototype.loadGoogleMaps=function(a){var c=settings.mapsDynamicAPIKey||"",b=document.createElement("script");window.googleMapsInit=a;b.type="text/javascript";b.src="http://maps.googleapis.com/maps/api/js?v=3.exp&key="+c+"&sensor=false&libraries=places&callback=googleMapsInit";document.body.appendChild(b)};
Connection.prototype.getCallbacks=function(a){a=a||{};a.error=a.error||function(a,b,d){console.error(b+" : "+d)};a.complete=a.complete||function(){};a.success=a.success||function(){console.log("success!")};return a};